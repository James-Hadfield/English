<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phrasal Verbs Master - Unit 16</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            min-height: 100vh;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
            }

            50% {
                box-shadow: 0 0 0 10px rgba(99, 102, 241, 0);
            }
        }

        .drag-item {
            cursor: grab;
            user-select: none;
        }

        .drag-item:active {
            cursor: grabbing;
        }

        .drop-zone {
            transition: all 0.2s ease;
        }

        .drop-zone.active {
            background-color: #e0e7ff;
            border-color: #6366f1;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- ICON COMPONENT ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    ref.current.innerHTML = '';
                    const icon = document.createElement('i');
                    icon.setAttribute('data-lucide', name);
                    ref.current.appendChild(icon);
                    window.lucide.createIcons({ root: ref.current, attrs: { width: size, height: size, class: className } });
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center"></span>;
        };

        // Utility: unbiased in-place shuffle that returns a new array
        const shuffleArray = (arr) => {
            const copy = [...arr];
            for (let i = copy.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [copy[i], copy[j]] = [copy[j], copy[i]];
            }
            return copy;
        };

        // --- PHRASAL VERB DATA ---
        const PHRASAL_VERBS = {
            // Verb + Adverb
            "stay up": { type: "v+adv", meaning: "not go to bed", example: "My brother stayed up all night.", transitive: false },
            "put away": { type: "v+adv", meaning: "store in the correct place", example: "Could you put away your books?", transitive: true, separable: true },
            "call off": { type: "v+adv", meaning: "cancel", example: "The meeting was called off.", transitive: true, separable: true },
            "get up": { type: "v+adv", meaning: "rise from bed", example: "What time did you get up?", transitive: false },
            "work out": { type: "v+adv", meaning: "exercise", example: "Jack works out every day.", transitive: false },
            "clean up": { type: "v+adv", meaning: "make tidy", example: "I'll clean the place up tomorrow.", transitive: true, separable: true },
            "pick up": { type: "v+adv", meaning: "lift/collect", example: "Can you pick up those books?", transitive: true, separable: true },
            "turn down": { type: "v+adv", meaning: "refuse", example: "Sandy turned down the job offer.", transitive: true, separable: true },
            "sort out": { type: "v+adv", meaning: "resolve", example: "We need to sort the problem out.", transitive: true, separable: true },
            "find out": { type: "v+adv", meaning: "discover", example: "You can find out more online.", transitive: true, separable: true },
            "give up": { type: "v+adv", meaning: "stop doing something", example: "He gave up smoking.", transitive: true, separable: true },
            "give in": { type: "v+adv", meaning: "finally agree/surrender", example: "She eventually gave in.", transitive: false },
            "blow up": { type: "v+adv", meaning: "inflate OR become angry", example: "We blew up the balloons.", transitive: "both", separable: true },
            "break down": { type: "v+adv", meaning: "stop working OR collapse", example: "The car broke down.", transitive: "both", separable: true },
            "make up": { type: "v+adv", meaning: "invent/create OR reconcile", example: "He made up an excuse.", transitive: true, separable: true },
            "look up": { type: "v+adv", meaning: "search for information", example: "Look the word up in your dictionary.", transitive: true, separable: true },

            // Verb + Preposition
            "wait for": { type: "v+prep", meaning: "await", example: "Jeff has been waiting for the bus.", transitive: true, separable: false },
            "talk into": { type: "v+prep", meaning: "persuade", example: "She was talked into going.", transitive: true, separable: false },
            "bump into": { type: "v+prep", meaning: "meet by chance", example: "I bumped into Roy today.", transitive: true, separable: false },
            "look after": { type: "v+prep", meaning: "take care of", example: "Please look after my goldfish.", transitive: true, separable: false },
            "look into": { type: "v+prep", meaning: "investigate", example: "Police are looking into the case.", transitive: true, separable: false },
            "look for": { type: "v+prep", meaning: "try to find", example: "I'm looking for Cathy.", transitive: true, separable: false },
            "pick on": { type: "v+prep", meaning: "treat unfairly", example: "You shouldn't pick on Lisa.", transitive: true, separable: false },

            // Verb + Adverb + Preposition
            "look forward to": { type: "v+adv+prep", meaning: "anticipate with pleasure", example: "Are you looking forward to the weekend?", transitive: true, separable: false },
            "get on with": { type: "v+adv+prep", meaning: "have a good relationship", example: "Fiona doesn't get on with her sister.", transitive: true, separable: false },
            "put up with": { type: "v+adv+prep", meaning: "tolerate", example: "I can't put up with this noise.", transitive: true, separable: false },

            // Special: Must separate
            "show around": { type: "v+adv", meaning: "give a tour", example: "I'll show my friends around.", transitive: true, separable: "must" },
            "ask out": { type: "v+adv", meaning: "invite on a date", example: "Tim asked Jenny out.", transitive: true, separable: "must" }
        };

        const FORMAL_EQUIVALENTS = {
            "look into": "investigate",
            "find out": "discover",
            "turn down": "refuse",
            "sort out": "resolve",
            "call off": "cancel",
            "put off": "postpone",
            "give up": "quit",
            "make up": "invent"
        };

        // --- QUIZ DATA BY MODULE ---
        const QUIZ_DATA = {
            m1: [
                { id: 101, q: "My brother ___ all night playing games.", a: "stayed up", opts: ["stayed up", "stayed for", "stay upping", "stayed into"], expl: "'Stay up' (verb + adverb) means to not go to bed." },
                { id: 102, q: "She was ___ going to the party by Simon.", a: "talked into", opts: ["talked into", "talked up", "talked for", "talk into"], expl: "'Talk into' (verb + preposition) means to persuade someone." },
                { id: 103, q: "Are you ___ the weekend?", a: "looking forward to", opts: ["looking forward to", "looking forward", "looking for to", "look forward to"], expl: "'Look forward to' (verb + adverb + preposition) means to anticipate with pleasure." },
                { id: 104, q: "Could you ___ your books, please?", a: "put away", opts: ["put away", "put into", "put for", "putting away"], expl: "'Put away' means to store something in its correct place." },
                { id: 105, q: "The barbecue was ___ because of rain.", a: "called off", opts: ["called off", "called for", "calling off", "called up"], expl: "'Call off' means to cancel something." }
            ],
            m2: [
                { id: 201, q: "What time did you ___ this morning?", a: "get up", opts: ["get up", "get up it", "get it up", "getting up"], expl: "'Get up' is intransitive - it doesn't need an object." },
                { id: 202, q: "I ___ Roy at the Cultural Centre today.", a: "bumped into", opts: ["bumped into", "bumped", "bump into", "bumped up"], expl: "'Bump into' is transitive - it needs an object (Roy)." },
                { id: 203, q: "Our car ___ yesterday.", a: "broke down", opts: ["broke down", "broke down it", "broke it down", "was broke down"], expl: "'Break down' (stop working) is intransitive - no object needed." },
                { id: 204, q: "Mr Ting ___ when he saw the mess.", a: "blew up", opts: ["blew up", "blew up it", "blew it up", "blown up"], expl: "'Blow up' (become angry) is intransitive - no object." },
                { id: 205, q: "We found balloons so we ___ for the party.", a: "blew them up", opts: ["blew them up", "blew up them", "blown them up", "blew up"], expl: "'Blow up' (inflate) is transitive and needs an object." }
            ],
            m3: [
                { id: 301, q: "Can you pick ___ please?", a: "them up", opts: ["them up", "up them", "they up", "them"], expl: "With pronouns, separable phrasal verbs MUST be split: pick + pronoun + up." },
                { id: 302, q: "Can you pick ___ please?", a: "up those books / those books up", opts: ["up those books / those books up", "only 'up those books'", "only 'those books up'", "those books"], expl: "With noun objects, either order works: pick up the books OR pick the books up." },
                { id: 303, q: "Please look ___ while I'm on holiday.", a: "after my goldfish", opts: ["after my goldfish", "my goldfish after", "after it", "it after"], expl: "'Look after' is inseparable - the object must come after the whole phrasal verb." },
                { id: 304, q: "I can't put ___.", a: "up with it", opts: ["up with it", "it up with", "up it with", "with it up"], expl: "Three-part phrasal verbs (verb + adverb + preposition) are NEVER separated." },
                { id: 305, q: "I'm going to show ___ my new house.", a: "my friends around", opts: ["my friends around", "around my friends", "them around", "around them"], expl: "'Show around' MUST be separated - the object goes between show and around." },
                { id: 306, q: "Tim is too shy to ask ___ to dinner.", a: "Jenny out", opts: ["Jenny out", "out Jenny", "her out", "out her"], expl: "'Ask out' MUST be separated - the object goes between ask and out." }
            ],
            m4: [
                { id: 401, q: "The police are ___ the murder case. (formal: investigating)", a: "looking into", opts: ["looking into", "looking for", "looking up", "looking after"], expl: "'Look into' is the informal equivalent of 'investigate'." },
                { id: 402, q: "Sandy ___ the job offer. (formal: refused)", a: "turned down", opts: ["turned down", "turned off", "turned up", "turned into"], expl: "'Turn down' is the informal equivalent of 'refuse'." },
                { id: 403, q: "We need to ___ the problem. (formal: resolve)", a: "sort out", opts: ["sort out", "sort up", "sort into", "sort for"], expl: "'Sort out' is the informal equivalent of 'resolve'." },
                { id: 404, q: "You can ___ more by visiting our website. (formal: discover)", a: "find out", opts: ["find out", "find up", "find into", "find for"], expl: "'Find out' is the informal equivalent of 'discover'." }
            ],
            m5: [
                { id: 501, q: "I'm really looking forward ___ our vacation.", a: "to", opts: ["to", "our vacation to", "for", ""], expl: "Three-part phrasal verbs cannot be separated. 'Looking forward to' stays together." },
                { id: 502, q: "Sarah eventually ___ and bought her son a bicycle.", a: "gave in", opts: ["gave in", "gave up", "give in", "given in"], expl: "'Give in' means to finally agree. 'Give up' means to stop doing something." },
                { id: 503, q: "Lawrence ___ drinking because of health problems.", a: "gave up", opts: ["gave up", "gave in", "give up", "given up"], expl: "'Give up' means to stop doing something permanently." },
                { id: 504, q: "I'm ___ Cathy. Have you seen her?", a: "looking for", opts: ["looking for", "looking up", "looking into", "looking after"], expl: "'Look for' means to try to find someone/something." },
                { id: 505, q: "___ the word in your dictionary.", a: "Look up", opts: ["Look up", "Look for", "Look into", "Look after"], expl: "'Look up' means to search for information in a reference source." },
                { id: 506, q: "Which sentence is CORRECT?", a: "I'm going to show my friends around.", opts: ["I'm going to show my friends around.", "I'm going to show around my friends.", "I'm going to show around them.", "I show my friends around going to."], expl: "'Show around' must be separated - object goes between show and around." }
            ]
        };

        // --- COMPREHENSIVE PHRASAL VERB TEST POOL ---
        // Each phrasal verb with a distinct meaning is a separate entry
        const PHRASAL_VERB_POOL = [
            // Module 1: Types of Phrasal Verbs
            { pv: "stay up", meaning: "remain awake", type: "v+adv", q: "My brother ___ all night playing games.", a: "stayed up", opts: ["stayed up", "stayed for", "stay upping", "stayed into"], expl: "'Stay up' (verb + adverb) means to not go to bed." },
            { pv: "put away", meaning: "store/tidy", type: "v+adv", q: "Could you ___ your books, please?", a: "put away", opts: ["put away", "put into", "put for", "putting away"], expl: "'Put away' means to store something in its correct place." },
            { pv: "call off", meaning: "cancel", type: "v+adv", q: "The barbecue was ___ because of rain.", a: "called off", opts: ["called off", "called for", "calling off", "called up"], expl: "'Call off' means to cancel something." },
            { pv: "look over", meaning: "review/examine", type: "v+adv", q: "I need to ___ this pile of documents today.", a: "look over", opts: ["look over", "look up", "look into", "look for"], expl: "'Look over' means to examine or review something." },
            { pv: "put off", meaning: "postpone", type: "v+adv", q: "Can we ask our boss to ___ the meeting until tomorrow?", a: "put off", opts: ["put off", "put away", "put up", "put down"], expl: "'Put off' means to postpone or delay something." },
            { pv: "talk into", meaning: "persuade", type: "v+prep", q: "She was ___ going to the party by Simon.", a: "talked into", opts: ["talked into", "talked up", "talked for", "talk into"], expl: "'Talk into' means to persuade someone to do something." },
            { pv: "wait for", meaning: "await", type: "v+prep", q: "Jeff has been ___ the bus for over an hour.", a: "waiting for", opts: ["waiting for", "waiting up", "wait for", "waited into"], expl: "'Wait for' means to stay until someone/something arrives." },
            { pv: "look forward to", meaning: "anticipate with pleasure", type: "v+adv+prep", q: "Are you ___ the weekend?", a: "looking forward to", opts: ["looking forward to", "looking forward", "looking for to", "look forward to"], expl: "'Look forward to' is a 3-part phrasal verb meaning to anticipate with pleasure." },
            { pv: "get on with", meaning: "have good relationship", type: "v+adv+prep", q: "Fiona doesn't ___ her sister.", a: "get on with", opts: ["get on with", "get up with", "get into", "get for"], expl: "'Get on with' means to have a good relationship with someone." },

            // Module 2: Transitive vs Intransitive
            { pv: "get up", meaning: "wake and rise", type: "v+adv", trans: "intrans", q: "What time did you ___ this morning?", a: "get up", opts: ["get up", "get up it", "get it up", "getting up"], expl: "'Get up' is intransitive - it doesn't need an object." },
            { pv: "work out", meaning: "exercise", type: "v+adv", trans: "intrans", q: "Jack ___ every day at the gym.", a: "works out", opts: ["works out", "works out it", "works it out", "work out"], expl: "'Work out' (exercise) is intransitive - no object needed." },
            { pv: "bump into", meaning: "meet by chance", type: "v+prep", trans: "trans", q: "I ___ Roy at the Cultural Centre today.", a: "bumped into", opts: ["bumped into", "bumped", "bump into", "bumped up"], expl: "'Bump into' is transitive - it needs an object (the person you met)." },
            { pv: "clean up", meaning: "tidy", type: "v+adv", trans: "trans", q: "I'll ___ the place tomorrow.", a: "clean up", opts: ["clean up", "clean into", "clean for", "cleaning up"], expl: "'Clean up' means to tidy or make clean." },
            { pv: "blow up (inflate)", meaning: "fill with air", type: "v+adv", trans: "trans", q: "We found balloons so we ___ for the party.", a: "blew them up", opts: ["blew them up", "blew up them", "blown them up", "blew up"], expl: "'Blow up' (inflate) is transitive and needs an object." },
            { pv: "blow up (angry)", meaning: "become very angry", type: "v+adv", trans: "intrans", q: "Mr Ting ___ when he saw the messy classroom.", a: "blew up", opts: ["blew up", "blew up it", "blew it up", "blown up"], expl: "'Blow up' (become angry) is intransitive - no object." },
            { pv: "break down (destroy)", meaning: "knock to ground", type: "v+adv", trans: "trans", q: "The police ___ the door.", a: "broke down", opts: ["broke down", "break down", "broke it down", "broken down"], expl: "'Break down' (destroy) is transitive - needs an object." },
            { pv: "break down (stop working)", meaning: "stop functioning", type: "v+adv", trans: "intrans", q: "Our car ___ yesterday.", a: "broke down", opts: ["broke down", "broke down it", "broke it down", "was broke down"], expl: "'Break down' (stop working) is intransitive - no object needed." },

            // Module 3: Separable vs Inseparable
            { pv: "pick up", meaning: "collect/lift", type: "v+adv", sep: true, q: "Can you pick ___ please? (those books)", a: "up those books / those books up", opts: ["up those books / those books up", "only 'up those books'", "only 'those books up'", "those books"], expl: "With noun objects, either order works for separable verbs." },
            { pv: "pick up (pronoun)", meaning: "collect/lift", type: "v+adv", sep: "must", q: "Can you pick ___ please? (them)", a: "them up", opts: ["them up", "up them", "they up", "them"], expl: "With pronouns, separable phrasal verbs MUST be split: pick + pronoun + up." },
            { pv: "look after", meaning: "take care of", type: "v+prep", sep: false, q: "Please look ___ while I'm on holiday.", a: "after my goldfish", opts: ["after my goldfish", "my goldfish after", "after it", "it after"], expl: "'Look after' is inseparable - object must come after the whole verb." },
            { pv: "put up with", meaning: "tolerate", type: "v+adv+prep", sep: false, q: "I can't put ___.", a: "up with it", opts: ["up with it", "it up with", "up it with", "with it up"], expl: "Three-part phrasal verbs are NEVER separated." },
            { pv: "show around", meaning: "give a tour", type: "v+adv", sep: "must", q: "I'm going to show ___ my new house.", a: "my friends around", opts: ["my friends around", "around my friends", "them around", "around them"], expl: "'Show around' MUST be separated - object goes between." },
            { pv: "ask out", meaning: "invite on date", type: "v+adv", sep: "must", q: "Tim is too shy to ask ___ to dinner.", a: "Jenny out", opts: ["Jenny out", "out Jenny", "her out", "out her"], expl: "'Ask out' MUST be separated - object goes between." },

            // Module 4: Formal vs Informal
            { pv: "look into", meaning: "investigate", type: "v+prep", formal: "investigate", q: "The police are ___ the murder case. (formal: investigating)", a: "looking into", opts: ["looking into", "looking for", "looking up", "looking after"], expl: "'Look into' is the informal equivalent of 'investigate'." },
            { pv: "find out", meaning: "discover", type: "v+adv", formal: "discover", q: "You can ___ more by visiting our website. (formal: discover)", a: "find out", opts: ["find out", "find up", "find into", "find for"], expl: "'Find out' is the informal equivalent of 'discover'." },
            { pv: "turn down", meaning: "refuse", type: "v+adv", formal: "refuse", q: "Sandy ___ the job offer. (formal: refused)", a: "turned down", opts: ["turned down", "turned off", "turned up", "turned into"], expl: "'Turn down' is the informal equivalent of 'refuse'." },
            { pv: "sort out", meaning: "resolve", type: "v+adv", formal: "resolve", q: "We need to ___ the problem. (formal: resolve)", a: "sort out", opts: ["sort out", "sort up", "sort into", "sort for"], expl: "'Sort out' is the informal equivalent of 'resolve'." },

            // Module 5: Common Errors
            { pv: "give in", meaning: "finally agree", type: "v+adv", q: "Sarah eventually ___ and bought her son a bicycle.", a: "gave in", opts: ["gave in", "gave up", "give in", "given in"], expl: "'Give in' means to finally agree. Don't confuse with 'give up'!" },
            { pv: "give up", meaning: "stop doing", type: "v+adv", q: "Lawrence ___ drinking because of health problems.", a: "gave up", opts: ["gave up", "gave in", "give up", "given up"], expl: "'Give up' means to stop doing something permanently." },
            { pv: "look for", meaning: "try to find", type: "v+prep", q: "I'm ___ Cathy. Have you seen her?", a: "looking for", opts: ["looking for", "looking up", "looking into", "looking after"], expl: "'Look for' means to try to find someone/something that is lost." },
            { pv: "look up", meaning: "search for info", type: "v+adv", q: "___ the word in your dictionary.", a: "Look up", opts: ["Look up", "Look for", "Look into", "Look after"], expl: "'Look up' means to search for information in a reference source." },
            { pv: "pick on", meaning: "treat unfairly", type: "v+prep", q: "You shouldn't ___ Lisa.", a: "pick on", opts: ["pick on", "pick up", "pick out", "pick into"], expl: "'Pick on' means to treat someone unfairly or bully them." },
            { pv: "make up (prepare)", meaning: "prepare/put together", type: "v+adv", q: "Can you ___ a list of all the things we need?", a: "make up", opts: ["make up", "make out", "make into", "make for"], expl: "'Make up' can mean to prepare something by putting things together." },
            { pv: "make up (pretend)", meaning: "invent/deceive", type: "v+adv", q: "I think Stephen is just ___ the whole story.", a: "making up", opts: ["making up", "making out", "making into", "making for"], expl: "'Make up' can also mean to invent or pretend something is true." }
        ];

        // Generate random test questions from the pool
        const generateTestQuestions = (count = 15) => {
            const shuffled = [...PHRASAL_VERB_POOL].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, count).map((item, index) => ({
                id: 1000 + index,
                q: item.q,
                a: item.a,
                opts: [...item.opts].sort(() => Math.random() - 0.5), // Randomize options too
                expl: item.expl,
                pv: item.pv
            }));
        };

        // Legacy: All module questions combined (for backwards compatibility)
        const ALL_QUESTIONS = [...QUIZ_DATA.m1, ...QUIZ_DATA.m2, ...QUIZ_DATA.m3, ...QUIZ_DATA.m4, ...QUIZ_DATA.m5];

        // --- UI COMPONENTS ---

        const Button = ({ onClick, children, variant = "primary", className = "", disabled = false, size = "md" }) => {
            const styles = {
                primary: "bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg hover:shadow-xl",
                secondary: "bg-white text-indigo-700 border-2 border-indigo-200 hover:bg-indigo-50",
                outline: "bg-transparent text-slate-600 border-2 border-slate-200 hover:bg-slate-100",
                success: "bg-emerald-600 text-white hover:bg-emerald-700 shadow-lg",
                danger: "bg-red-500 text-white hover:bg-red-600",
                ghost: "bg-transparent text-slate-500 hover:bg-slate-100 hover:text-slate-700"
            };
            const sizes = {
                sm: "px-3 py-2 text-sm",
                md: "px-5 py-3 text-base",
                lg: "px-8 py-4 text-xl"
            };
            return (
                <button
                    disabled={disabled}
                    onClick={onClick}
                    className={`rounded-xl font-bold transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed active:scale-98 ${styles[variant]} ${sizes[size]} ${className}`}
                >
                    {children}
                </button>
            );
        };

        const ProgressBar = ({ current, total, color = "bg-indigo-500" }) => (
            <div className="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                <div className={`${color} h-full transition-all duration-500`} style={{ width: `${(current / total) * 100}%` }}></div>
            </div>
        );

        const StepIndicator = ({ steps, current, maxReached, onStepClick }) => {
            const max = maxReached !== undefined ? maxReached : current;
            return (
                <div className="flex items-center gap-1 mb-6 overflow-x-auto pb-2">
                    {steps.map((step, i) => (
                        <React.Fragment key={i}>
                            <button
                                onClick={() => i <= max && onStepClick && onStepClick(i)}
                                disabled={i > max}
                                className={`flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap ${i === current ? 'bg-indigo-600 text-white shadow-md' :
                                    i <= max ? 'bg-indigo-100 text-indigo-700 hover:bg-indigo-200 cursor-pointer' :
                                        'bg-slate-100 text-slate-400 cursor-not-allowed'
                                    }`}
                            >
                                {i <= max && i !== current ? <Icon name="check" size={16} /> : <span className="w-5 h-5 rounded-full bg-current opacity-20 flex items-center justify-center text-xs">{i + 1}</span>}
                                <span className="hidden sm:inline">{step}</span>
                            </button>
                            {i < steps.length - 1 && <div className="w-4 h-0.5 bg-slate-200 shrink-0"></div>}
                        </React.Fragment>
                    ))}
                </div>
            );
        };

        // --- TEACHER MODELING COMPONENT ---
        const TeacherModel = ({ title, children, icon = "lightbulb" }) => (
            <div className="bg-gradient-to-br from-amber-50 to-orange-50 border-2 border-amber-200 rounded-2xl p-6 mb-6">
                <div className="flex items-center gap-3 mb-4">
                    <div className="bg-amber-500 text-white p-2 rounded-xl">
                        <Icon name={icon} size={24} />
                    </div>
                    <h3 className="text-xl font-bold text-amber-900">{title}</h3>
                    <span className="ml-auto bg-amber-200 text-amber-800 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide">Teacher Model</span>
                </div>
                <div className="text-amber-900">{children}</div>
            </div>
        );

        // --- WORKED EXAMPLE COMPONENT ---
        const WorkedExample = ({ sentence, parts, note }) => (
            <div className="bg-white rounded-xl p-5 shadow-sm border border-slate-200 my-4">
                <div className="text-lg font-medium text-slate-800 mb-4 flex items-start gap-2">
                    <Icon name="message-circle" size={20} className="text-indigo-500 shrink-0 mt-1" />
                    <span>"{sentence}"</span>
                </div>
                <div className="flex flex-wrap items-center gap-2 mb-3">
                    {parts.map((part, i) => (
                        <span key={i} className={`px-3 py-2 rounded-lg text-sm font-bold ${part.type === 'verb' ? 'bg-blue-100 text-blue-800 border-2 border-blue-300' :
                            part.type === 'adverb' ? 'bg-purple-100 text-purple-800 border-2 border-purple-300' :
                                part.type === 'preposition' ? 'bg-green-100 text-green-800 border-2 border-green-300' :
                                    part.type === 'object' ? 'bg-orange-100 text-orange-800 border-2 border-orange-300' :
                                        'bg-slate-100 text-slate-600'
                            }`}>
                            {part.word}
                            <span className="block text-xs font-normal opacity-70">{part.label}</span>
                        </span>
                    ))}
                </div>
                {note && <p className="text-sm text-slate-500 italic flex items-center gap-2"><Icon name="info" size={14} /> {note}</p>}
            </div>
        );

        // --- CONCEPT CHECK COMPONENT (simplified for use in ConceptCheckStep) ---
        const ConceptCheck = ({ question, options, correctAnswer, explanation, onAnswer }) => {
            const [selected, setSelected] = useState(null);
            const [showResult, setShowResult] = useState(false);
            const shuffledOptions = useMemo(() => shuffleArray(options), []);

            const handleSelect = (option) => {
                if (showResult) return;
                setSelected(option);
                setShowResult(true);
                if (onAnswer) onAnswer(option === correctAnswer);
            };

            const isCorrect = selected === correctAnswer;

            return (
                <div className="bg-white rounded-xl p-5 border-2 border-slate-200">
                    <p className="text-lg font-medium text-slate-800 mb-4">{question}</p>
                    <div className="space-y-2">
                        {shuffledOptions.map((option, i) => {
                            let btnClass = "bg-slate-50 border-2 border-slate-200 hover:border-indigo-400";
                            if (showResult) {
                                if (option === correctAnswer) btnClass = "bg-green-100 border-2 border-green-500 text-green-800";
                                else if (option === selected) btnClass = "bg-red-100 border-2 border-red-400 text-red-700";
                                else btnClass = "bg-slate-50 border-2 border-slate-100 opacity-50";
                            }
                            return (
                                <button key={i} onClick={() => handleSelect(option)} disabled={showResult}
                                    className={`w-full p-3 rounded-lg font-medium text-left transition-all ${btnClass}`}>
                                    {option}
                                </button>
                            );
                        })}
                    </div>
                    {showResult && (
                        <div className={`mt-4 p-3 rounded-lg ${isCorrect ? 'bg-green-50 border border-green-200' : 'bg-amber-50 border border-amber-200'}`}>
                            <p className="font-bold text-sm mb-1">{isCorrect ? 'âœ“ Correct!' : 'âœ— Not quite'}</p>
                            <p className="text-slate-600 text-sm">{explanation}</p>
                        </div>
                    )}
                </div>
            );
        };

        // --- CONCEPT CHECK STEP COMPONENT (dedicated step for concept checks) ---
        const ConceptCheckStep = ({ questions, onComplete, onReviewRequest }) => {
            const [currentIndex, setCurrentIndex] = useState(0);
            const [wrongAnswers, setWrongAnswers] = useState([]);
            const [allAnswered, setAllAnswered] = useState(false);
            const [answered, setAnswered] = useState(false);

            const currentQ = questions[currentIndex];
            const isLast = currentIndex === questions.length - 1;
            const hasWrongAnswers = wrongAnswers.length > 0;

            const handleAnswer = (isCorrect) => {
                setAnswered(true);
                if (!isCorrect) {
                    setWrongAnswers(prev => [...prev, currentQ.topic]);
                }
            };

            const handleNext = () => {
                if (isLast) {
                    setAllAnswered(true);
                } else {
                    setCurrentIndex(prev => prev + 1);
                    setAnswered(false);
                }
            };

            if (allAnswered) {
                return (
                    <div className="space-y-6 fade-in">
                        <div className={`p-6 rounded-2xl ${hasWrongAnswers ? 'bg-amber-50 border-2 border-amber-200' : 'bg-green-50 border-2 border-green-200'}`}>
                            <div className="flex items-center gap-3 mb-4">
                                <div className={`p-3 rounded-xl ${hasWrongAnswers ? 'bg-amber-500' : 'bg-green-500'} text-white`}>
                                    <Icon name={hasWrongAnswers ? "alert-circle" : "check-circle"} size={28} />
                                </div>
                                <div>
                                    <h3 className="text-xl font-bold">{hasWrongAnswers ? 'Review Suggested' : 'Great Job!'}</h3>
                                    <p className="text-slate-600">{hasWrongAnswers
                                        ? `You got ${questions.length - wrongAnswers.length}/${questions.length} correct.`
                                        : 'You understood all the key concepts!'}</p>
                                </div>
                            </div>

                            {hasWrongAnswers && (
                                <div className="bg-white p-4 rounded-xl mb-4">
                                    <p className="font-medium text-slate-700 mb-2">Review these topics:</p>
                                    <ul className="list-disc list-inside text-slate-600">
                                        {wrongAnswers.map((topic, i) => <li key={i}>{topic}</li>)}
                                    </ul>
                                </div>
                            )}

                            <div className="flex gap-3 justify-end">
                                {hasWrongAnswers && onReviewRequest && (
                                    <Button onClick={onReviewRequest} variant="outline">
                                        <Icon name="arrow-left" size={16} /> Go Back to Learn
                                    </Button>
                                )}
                                <Button onClick={onComplete} variant="primary">
                                    Continue <Icon name="arrow-right" size={16} />
                                </Button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-y-6 fade-in">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-xl font-bold text-slate-800">Quick Check</h2>
                        <span className="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-sm font-medium">
                            {currentIndex + 1} / {questions.length}
                        </span>
                    </div>

                    {currentQ.topic && (
                        <p className="text-sm text-slate-500 -mt-4 mb-4">Topic: {currentQ.topic}</p>
                    )}

                    <ConceptCheck
                        key={currentIndex}
                        question={currentQ.question}
                        options={currentQ.options}
                        correctAnswer={currentQ.correctAnswer}
                        explanation={currentQ.explanation}
                        onAnswer={handleAnswer}
                    />

                    {answered && (
                        <div className="flex justify-end">
                            <Button onClick={handleNext} variant="primary">
                                {isLast ? 'See Results' : 'Next'} <Icon name="arrow-right" size={16} />
                            </Button>
                        </div>
                    )}
                </div>
            );
        };

        // --- INTERACTIVE SORTING ACTIVITY ---
        const SortingActivity = ({ items, categories, onComplete }) => {
            const [sorted, setSorted] = useState({});
            const [available, setAvailable] = useState(items);
            const [feedback, setFeedback] = useState(null);
            const [draggedItem, setDraggedItem] = useState(null);
            const [hasAttempted, setHasAttempted] = useState(false);
            const [revealed, setRevealed] = useState(false);
            const [completionTriggered, setCompletionTriggered] = useState(false);

            const triggerComplete = useCallback(() => {
                setCompletionTriggered(prev => {
                    if (!prev && onComplete) onComplete();
                    return true;
                });
            }, [onComplete]);

            const handleDragStart = (e, item, sourceCategory) => {
                setDraggedItem({ item, sourceCategory });
                e.dataTransfer.effectAllowed = 'move';
                // Set data for drag operation (required for Firefox)
                e.dataTransfer.setData('text/plain', JSON.stringify(item));
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleDrop = (e, targetCategoryId) => {
                e.preventDefault();
                if (!draggedItem) return;

                const { item, sourceCategory } = draggedItem;

                if (sourceCategory === targetCategoryId) {
                    setDraggedItem(null);
                    return;
                }

                setSorted(prev => ({
                    ...prev,
                    [targetCategoryId]: [...(prev[targetCategoryId] || []), item]
                }));

                if (sourceCategory === 'available') {
                    setAvailable(prev => prev.filter(i => i.word !== item.word));
                } else {
                    setSorted(prev => ({
                        ...prev,
                        [sourceCategory]: prev[sourceCategory].filter(i => i.word !== item.word)
                    }));
                }
                setDraggedItem(null);
            };

            const handleDropToAvailable = (e) => {
                e.preventDefault();
                if (!draggedItem) return;

                const { item, sourceCategory } = draggedItem;

                if (sourceCategory === 'available') {
                    setDraggedItem(null);
                    return;
                }

                setAvailable(prev => [...prev, item]);
                setSorted(prev => ({
                    ...prev,
                    [sourceCategory]: prev[sourceCategory].filter(i => i.word !== item.word)
                }));
                setDraggedItem(null);
            };

            const checkAnswers = () => {
                setHasAttempted(true);
                let correct = 0;
                let total = items.length;

                Object.entries(sorted).forEach(([cat, sortedItems]) => {
                    sortedItems.forEach(item => {
                        if (item.category === cat) correct++;
                    });
                });

                setFeedback({ correct, total, percentage: Math.round((correct / total) * 100) });
                if (correct === total) {
                    setTimeout(triggerComplete, 1200);
                }
            };

            const revealAnswers = () => {
                const answerKey = categories.reduce((acc, cat) => {
                    acc[cat.id] = items.filter(item => item.category === cat.id);
                    return acc;
                }, {});
                setDraggedItem(null);
                setSorted(answerKey);
                setAvailable([]);
                setFeedback({ correct: items.length, total: items.length, percentage: 100, revealed: true });
                setRevealed(true);
            };

            const reset = () => {
                setSorted({});
                setAvailable(items);
                setFeedback(null);
                setDraggedItem(null);
                setHasAttempted(false);
                setRevealed(false);
                setCompletionTriggered(false);
            };

            return (
                <div className="space-y-6">
                    {/* Available Items */}
                    <div
                        className={`bg-slate-100 rounded-xl p-4 min-h-24 transition-colors ${draggedItem && draggedItem.sourceCategory !== 'available' ? 'bg-indigo-50 border-2 border-indigo-200 border-dashed' : ''}`}
                        onDragOver={handleDragOver}
                        onDrop={handleDropToAvailable}
                    >
                        <p className="text-sm font-medium text-slate-500 mb-3">Drag items to the correct category below:</p>
                        <div className="flex flex-wrap gap-2">
                            {available.map((item, i) => (
                                <div
                                    key={i}
                                    draggable={!feedback}
                                    onDragStart={(e) => handleDragStart(e, item, 'available')}
                                    className="px-4 py-2 bg-white rounded-lg shadow-sm border-2 border-slate-200 font-bold text-slate-700 cursor-grab active:cursor-grabbing hover:border-indigo-400 hover:bg-indigo-50 transition-all select-none"
                                >
                                    {item.word}
                                </div>
                            ))}
                            {available.length === 0 && <p className="text-slate-400 italic">All items sorted!</p>}
                        </div>
                    </div>

                    {/* Categories */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {categories.map(cat => (
                            <div
                                key={cat.id}
                                className={`rounded-xl p-4 border-2 border-dashed min-h-32 transition-all ${cat.color} ${draggedItem && draggedItem.sourceCategory !== cat.id ? 'bg-opacity-50 border-indigo-400' : ''}`}
                                onDragOver={handleDragOver}
                                onDrop={(e) => handleDrop(e, cat.id)}
                            >
                                <h4 className="font-bold text-sm mb-3 flex items-center gap-2">
                                    <Icon name={cat.icon} size={16} />
                                    {cat.name}
                                </h4>
                                <div className="flex flex-wrap gap-2">
                                    {(sorted[cat.id] || []).map((item, i) => (
                                        <div
                                            key={i}
                                            draggable={!feedback}
                                            onDragStart={(e) => handleDragStart(e, item, cat.id)}
                                            className={`px-3 py-1 rounded-lg text-sm font-medium flex items-center gap-1 cursor-grab active:cursor-grabbing select-none ${feedback ? (item.category === cat.id ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800') : 'bg-white shadow-sm'
                                                }`}
                                        >
                                            {item.word}
                                            {!feedback && <Icon name="move" size={12} className="opacity-30" />}
                                            {feedback && (item.category === cat.id ? <Icon name="check" size={14} /> : <Icon name="x" size={14} />)}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Feedback & Controls */}
                    {feedback && (
                        <div className={`p-4 rounded-xl text-center font-bold ${feedback.percentage === 100 ? 'bg-green-100 text-green-800' : 'bg-amber-100 text-amber-800'}`}>
                            {feedback.percentage === 100 ? 'ðŸŽ‰ Perfect! All correct!' : `${feedback.correct}/${feedback.total} correct (${feedback.percentage}%)`}
                        </div>
                    )}

                    <div className="flex gap-3 justify-center flex-wrap">
                        <Button variant="outline" onClick={reset} size="sm">
                            <Icon name="refresh-cw" size={16} /> Reset
                        </Button>
                        <Button variant="primary" onClick={checkAnswers} disabled={available.length > 0} size="sm">
                            <Icon name="check-circle" size={16} /> Check Answers
                        </Button>
                        {hasAttempted && !revealed && feedback && feedback.percentage < 100 && (
                            <Button variant="secondary" onClick={revealAnswers} size="sm">
                                <Icon name="eye" size={16} /> Reveal answers
                            </Button>
                        )}
                        {(revealed || (feedback && feedback.percentage === 100)) && (
                            <Button variant="primary" onClick={triggerComplete} size="sm" disabled={completionTriggered}>
                                Continue <Icon name="arrow-right" size={16} />
                            </Button>
                        )}
                    </div>
                </div>
            );
        };

        // --- ERROR CORRECTION ACTIVITY ---
        const ErrorCorrectionActivity = ({ items, onComplete }) => {
            const [currentIndex, setCurrentIndex] = useState(0);
            const [selectedError, setSelectedError] = useState(null);
            const [showFeedback, setShowFeedback] = useState(false);
            const [score, setScore] = useState(0);

            const current = items[currentIndex];
            // Simplified: just 2 choices - correct or has error
            const correctAnswer = current.hasError ? 'has_error' : 'correct';
            const options = useMemo(() => shuffleArray(['correct', 'has_error']), [currentIndex]);

            const handleSelect = (option) => {
                setSelectedError(option);
                setShowFeedback(true);
                if (option === correctAnswer) {
                    setScore(s => s + 1);
                }
            };

            const next = () => {
                if (currentIndex < items.length - 1) {
                    setCurrentIndex(i => i + 1);
                    setSelectedError(null);
                    setShowFeedback(false);
                } else {
                    onComplete && onComplete(score + (selectedError === correctAnswer ? 1 : 0), items.length);
                }
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center text-sm">
                        <span className="text-slate-500">Question {currentIndex + 1} of {items.length}</span>
                        <span className="font-bold text-indigo-600">Score: {score}</span>
                    </div>
                    <ProgressBar current={currentIndex + 1} total={items.length} />

                    <div className="bg-white rounded-2xl p-6 shadow-lg border border-slate-200">
                        <p className="text-slate-500 mb-2 text-sm font-medium">Is this sentence correct?</p>
                        <p className="text-2xl font-bold text-slate-800 mb-6 p-4 bg-slate-50 rounded-xl">
                            {current.sentence}
                        </p>

                        <div className="grid grid-cols-2 gap-4">
                            {options.map(option => {
                                const labels = {
                                    'correct': 'âœ“ Correct',
                                    'has_error': 'âœ— Has an Error'
                                };
                                let btnClass = "bg-slate-50 border-2 border-slate-200 hover:border-indigo-400";
                                if (showFeedback) {
                                    if (option === correctAnswer) btnClass = "bg-green-100 border-2 border-green-500";
                                    else if (option === selectedError) btnClass = "bg-red-100 border-2 border-red-400";
                                    else btnClass = "bg-slate-50 border-2 border-slate-100 opacity-50";
                                }
                                return (
                                    <button
                                        key={option}
                                        onClick={() => !showFeedback && handleSelect(option)}
                                        disabled={showFeedback}
                                        className={`p-4 rounded-xl font-medium text-left transition-all ${btnClass}`}
                                    >
                                        {labels[option]}
                                    </button>
                                );
                            })}
                        </div>

                        {showFeedback && (
                            <div className={`mt-6 p-4 rounded-xl ${selectedError === correctAnswer ? 'bg-green-50 border border-green-200' : 'bg-amber-50 border border-amber-200'}`}>
                                <p className="font-bold mb-2">{selectedError === correctAnswer ? 'âœ“ Correct!' : 'âœ— Not quite'}</p>
                                <p className="text-slate-700">{current.explanation}</p>
                                {current.correction && <p className="mt-2 font-medium text-green-700">Correct: "{current.correction}"</p>}
                            </div>
                        )}
                    </div>

                    {showFeedback && (
                        <div className="flex justify-end">
                            <Button onClick={next} variant="primary">
                                {currentIndex < items.length - 1 ? 'Next' : 'Finish'} <Icon name="arrow-right" size={18} />
                            </Button>
                        </div>
                    )}
                </div>
            );
        };

        // --- MATCHING ACTIVITY ---
        const MatchingActivity = ({ pairs, onComplete }) => {
            const [selected, setSelected] = useState({ left: null, right: null });
            const [matched, setMatched] = useState([]);
            const [wrong, setWrong] = useState(null);
            const [hasAttempted, setHasAttempted] = useState(false);
            const [revealed, setRevealed] = useState(false);
            const [completionTriggered, setCompletionTriggered] = useState(false);

            const triggerComplete = useCallback(() => {
                setCompletionTriggered(prev => {
                    if (!prev && onComplete) onComplete();
                    return true;
                });
            }, [onComplete]);

            const leftItems = pairs.map(p => p.phrasal);
            const rightItems = useMemo(() => [...pairs.map(p => p.formal)].sort(() => Math.random() - 0.5), []);

            const handleSelect = (side, item) => {
                const newSelected = { ...selected, [side]: item };
                setSelected(newSelected);
                setWrong(null);

                if (newSelected.left && newSelected.right) {
                    setHasAttempted(true);
                    const pair = pairs.find(p => p.phrasal === newSelected.left);
                    if (pair && pair.formal === newSelected.right) {
                        setMatched(m => {
                            const updated = [...m, newSelected.left];
                            if (updated.length === pairs.length) {
                                setTimeout(triggerComplete, 800);
                            }
                            return updated;
                        });
                        setSelected({ left: null, right: null });
                    } else {
                        setWrong(newSelected);
                        setTimeout(() => {
                            setSelected({ left: null, right: null });
                            setWrong(null);
                        }, 800);
                    }
                }
            };

            const revealAnswers = () => {
                setMatched(pairs.map(p => p.phrasal));
                setSelected({ left: null, right: null });
                setWrong(null);
                setRevealed(true);
            };

            return (
                <div className="space-y-6">
                    <p className="text-slate-600 text-center">Match the phrasal verbs (left) with their formal equivalents (right)</p>
                    <div className="flex justify-center text-sm font-medium text-indigo-600">
                        Matched: {matched.length}/{pairs.length}
                    </div>

                    <div className="grid grid-cols-2 gap-4 max-w-2xl mx-auto">
                        <div className="space-y-2">
                            <p className="text-xs font-bold text-slate-400 uppercase tracking-wide mb-2">Phrasal Verbs (Informal)</p>
                            {leftItems.map(item => {
                                const isMatched = matched.includes(item);
                                const isSelected = selected.left === item;
                                const isWrong = wrong?.left === item;
                                return (
                                    <button
                                        key={item}
                                        onClick={() => !isMatched && handleSelect('left', item)}
                                        disabled={isMatched}
                                        className={`w-full p-3 rounded-xl font-bold text-left transition-all ${isMatched ? 'bg-green-100 text-green-700 opacity-60' :
                                            isWrong ? 'bg-red-100 border-2 border-red-400 text-red-700' :
                                                isSelected ? 'bg-indigo-100 border-2 border-indigo-500 text-indigo-700' :
                                                    'bg-white border-2 border-slate-200 hover:border-indigo-300'
                                            }`}
                                    >
                                        {item}
                                    </button>
                                );
                            })}
                        </div>
                        <div className="space-y-2">
                            <p className="text-xs font-bold text-slate-400 uppercase tracking-wide mb-2">Single Verbs (Formal)</p>
                            {rightItems.map(item => {
                                const matchedPair = pairs.find(p => p.formal === item);
                                const isMatched = matched.includes(matchedPair?.phrasal);
                                const isSelected = selected.right === item;
                                const isWrong = wrong?.right === item;
                                return (
                                    <button
                                        key={item}
                                        onClick={() => !isMatched && handleSelect('right', item)}
                                        disabled={isMatched}
                                        className={`w-full p-3 rounded-xl font-bold text-left transition-all ${isMatched ? 'bg-green-100 text-green-700 opacity-60' :
                                            isWrong ? 'bg-red-100 border-2 border-red-400 text-red-700' :
                                                isSelected ? 'bg-indigo-100 border-2 border-indigo-500 text-indigo-700' :
                                                    'bg-white border-2 border-slate-200 hover:border-indigo-300'
                                            }`}
                                    >
                                        {item}
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {revealed && (
                        <div className="bg-indigo-50 border border-indigo-100 rounded-xl p-4 max-w-2xl mx-auto fade-in">
                            <h4 className="font-bold text-indigo-800 mb-3 flex items-center gap-2">
                                <Icon name="eye" size={16} /> Answer key
                            </h4>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-slate-700">
                                {pairs.map(pair => (
                                    <div key={pair.phrasal} className="flex items-center gap-2 bg-white/60 px-3 py-2 rounded-lg border border-indigo-100">
                                        <span className="font-bold text-indigo-900">{pair.phrasal}</span>
                                        <Icon name="arrow-right" size={14} className="text-indigo-500" />
                                        <span>{pair.formal}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    <div className="flex flex-wrap justify-center gap-3">
                        {hasAttempted && !revealed && matched.length < pairs.length && (
                            <Button variant="secondary" onClick={revealAnswers} size="sm">
                                <Icon name="eye" size={16} /> Reveal answers
                            </Button>
                        )}
                        {(revealed || matched.length === pairs.length) && (
                            <Button variant="primary" onClick={triggerComplete} size="sm" disabled={completionTriggered}>
                                Continue <Icon name="arrow-right" size={16} />
                            </Button>
                        )}
                    </div>

                    {matched.length === pairs.length && (
                        <div className="text-center p-4 bg-green-100 rounded-xl text-green-800 font-bold fade-in">
                            ðŸŽ‰ All matched! Great job!
                        </div>
                    )}
                </div>
            );
        };

        // --- SENTENCE BUILDER ACTIVITY ---
        const SentenceBuilderActivity = ({ items, onComplete }) => {
            const [currentIndex, setCurrentIndex] = useState(0);
            const [selected, setSelected] = useState([]);
            const [available, setAvailable] = useState([]);
            const [showFeedback, setShowFeedback] = useState(false);
            const [score, setScore] = useState(0);

            const current = items[currentIndex];

            useEffect(() => {
                setAvailable([...current.words].sort(() => Math.random() - 0.5));
                setSelected([]);
                setShowFeedback(false);
            }, [currentIndex]);

            const handleWordClick = (word, fromSelected) => {
                if (showFeedback) return;
                if (fromSelected) {
                    setSelected(s => s.filter((w, i) => i !== selected.indexOf(word) || s.indexOf(word) !== s.lastIndexOf(word) ? w !== word || i !== selected.lastIndexOf(word) : true).filter((_, i) => i !== selected.lastIndexOf(word)));
                    setAvailable(a => [...a, word]);
                } else {
                    setAvailable(a => {
                        const idx = a.indexOf(word);
                        return a.filter((_, i) => i !== idx);
                    });
                    setSelected(s => [...s, word]);
                }
            };

            const checkAnswer = () => {
                const userAnswer = selected.join(' ');
                const isCorrect = current.correct.includes(userAnswer);
                setShowFeedback(true);
                if (isCorrect) setScore(s => s + 1);
            };

            const next = () => {
                if (currentIndex < items.length - 1) {
                    setCurrentIndex(i => i + 1);
                } else {
                    onComplete && onComplete(score, items.length);
                }
            };

            const isCorrect = showFeedback && current.correct.includes(selected.join(' '));

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center text-sm">
                        <span className="text-slate-500">Sentence {currentIndex + 1} of {items.length}</span>
                        <span className="font-bold text-indigo-600">Score: {score}</span>
                    </div>
                    <ProgressBar current={currentIndex + 1} total={items.length} />

                    <div className="bg-white rounded-2xl p-6 shadow-lg border border-slate-200">
                        <p className="text-slate-500 mb-4">Arrange the words to form a correct sentence:</p>

                        {/* Answer area */}
                        <div className={`min-h-16 p-4 rounded-xl border-2 border-dashed mb-6 flex flex-wrap gap-2 ${showFeedback ? (isCorrect ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300') : 'bg-slate-50 border-slate-300'
                            }`}>
                            {selected.length === 0 && <span className="text-slate-400 italic">Click words below to build your sentence...</span>}
                            {selected.map((word, i) => (
                                <button
                                    key={i}
                                    onClick={() => handleWordClick(word, true)}
                                    disabled={showFeedback}
                                    className="px-4 py-2 bg-indigo-100 text-indigo-800 rounded-lg font-bold hover:bg-indigo-200 transition-all"
                                >
                                    {word}
                                </button>
                            ))}
                        </div>

                        {/* Available words */}
                        <div className="flex flex-wrap gap-2 justify-center">
                            {available.map((word, i) => (
                                <button
                                    key={i}
                                    onClick={() => handleWordClick(word, false)}
                                    disabled={showFeedback}
                                    className="px-4 py-2 bg-white border-2 border-slate-200 rounded-lg font-bold hover:border-indigo-400 hover:bg-indigo-50 transition-all"
                                >
                                    {word}
                                </button>
                            ))}
                        </div>

                        {showFeedback && (
                            <div className={`mt-6 p-4 rounded-xl ${isCorrect ? 'bg-green-100' : 'bg-amber-100'}`}>
                                <p className="font-bold mb-2">{isCorrect ? 'âœ“ Correct!' : 'âœ— Not quite right'}</p>
                                <p className="text-slate-700">Correct answer: "{current.correct[0]}"</p>
                                {current.explanation && <p className="text-sm text-slate-500 mt-2">{current.explanation}</p>}
                            </div>
                        )}
                    </div>

                    <div className="flex justify-between">
                        <Button
                            variant="outline"
                            onClick={() => { setAvailable([...current.words].sort(() => Math.random() - 0.5)); setSelected([]); }}
                            disabled={showFeedback}
                            size="sm"
                        >
                            <Icon name="refresh-cw" size={16} /> Reset
                        </Button>
                        {!showFeedback ? (
                            <Button onClick={checkAnswer} variant="primary" disabled={selected.length === 0}>
                                Check Answer <Icon name="check" size={18} />
                            </Button>
                        ) : (
                            <Button onClick={next} variant="primary">
                                {currentIndex < items.length - 1 ? 'Next' : 'Finish'} <Icon name="arrow-right" size={18} />
                            </Button>
                        )}
                    </div>
                </div>
            );
        };

        // --- QUIZ INTERFACE ---
        const QuizInterface = ({ questions, onComplete, title = "Quiz" }) => {
            const [mode, setMode] = useState('quiz');
            const [activeQuestions, setActiveQuestions] = useState(questions);
            const [idx, setIdx] = useState(0);
            const [history, setHistory] = useState({});
            const [answered, setAnswered] = useState(false);
            const [selectedOption, setSelectedOption] = useState(null);

            const q = activeQuestions[idx];
            const shuffledOptions = useMemo(() => (q ? shuffleArray(q.opts) : []), [q?.id]);

            const handleAnswer = (choice) => {
                if (answered) return;
                const isCorrect = choice === q.a || (Array.isArray(q.a) && q.a.includes(choice));
                setSelectedOption(choice);
                setAnswered(true);
                setHistory(prev => ({ ...prev, [q.id]: { q, selected: choice, isCorrect, skipped: false } }));
            };

            const handleSkip = () => {
                if (answered) return;
                setHistory(prev => ({ ...prev, [q.id]: { q, selected: null, isCorrect: false, skipped: true } }));
                next();
            };

            const next = () => {
                setAnswered(false);
                setSelectedOption(null);
                if (idx < activeQuestions.length - 1) {
                    setIdx(idx + 1);
                } else {
                    setMode('review');
                }
            };

            const getScore = () => Object.values(history).filter(h => h.isCorrect).length;

            const handleRetryMistakes = () => {
                const mistakes = Object.values(history).filter(h => !h.isCorrect).map(h => h.q);
                setActiveQuestions(mistakes);
                setHistory({});
                setIdx(0);
                setMode('quiz');
                setAnswered(false);
                setSelectedOption(null);
            };

            if (mode === 'review') {
                const score = getScore();
                const total = Object.keys(history).length;
                const mistakes = Object.values(history).filter(h => !h.isCorrect);

                return (
                    <div className="w-full fade-in bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
                        <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-8 text-center text-white">
                            <h2 className="text-3xl font-black mb-2">{title} Complete!</h2>
                            <div className="text-5xl font-black mb-2">{score}/{total}</div>
                            <p className="text-indigo-200">{score === total ? "Perfect score! ðŸŽ‰" : "Good effort! Review your mistakes below."}</p>
                        </div>

                        <div className="p-6">
                            {mistakes.length > 0 && (
                                <div className="mb-6">
                                    <h3 className="text-lg font-bold text-red-600 mb-4 flex items-center gap-2">
                                        <Icon name="alert-circle" size={20} /> Review Mistakes
                                    </h3>
                                    <div className="space-y-3">
                                        {mistakes.map((m, i) => (
                                            <div key={i} className="bg-red-50 p-4 rounded-xl border border-red-100">
                                                <p className="font-medium text-slate-800 mb-2">{m.q.q}</p>
                                                <div className="grid grid-cols-2 gap-2 text-sm">
                                                    <span className="text-red-600">
                                                        <Icon name="x" size={14} className="inline" /> {m.skipped ? 'Skipped' : <>Your answer: <strong>{m.selected}</strong></>}
                                                    </span>
                                                    <span className="text-green-600"><Icon name="check" size={14} className="inline" /> Correct: <strong>{Array.isArray(m.q.a) ? m.q.a[0] : m.q.a}</strong></span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            <div className="flex flex-wrap gap-3 justify-center">
                                {mistakes.length > 0 && (
                                    <Button onClick={handleRetryMistakes} variant="secondary">
                                        <Icon name="refresh-cw" size={18} /> Retry Mistakes
                                    </Button>
                                )}
                                <Button onClick={() => onComplete(score, total)} variant="primary">
                                    Continue <Icon name="arrow-right" size={18} />
                                </Button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (!q) {
                return (
                    <div className="w-full fade-in bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
                        <div className="p-6 text-center text-slate-500">No quiz questions available.</div>
                    </div>
                );
            }

            return (
                <div className="w-full fade-in">
                    <div className="mb-4 flex justify-between items-center text-sm">
                        <span className="text-slate-500 font-medium">Question {idx + 1}/{activeQuestions.length}</span>
                        <span className="font-bold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full">Score: {getScore()}</span>
                    </div>

                    <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
                        <ProgressBar current={idx + 1} total={activeQuestions.length} />

                        <div className="p-6 sm:p-8">
                            <h3 className="text-xl sm:text-2xl font-bold text-slate-800 mb-6 leading-relaxed">
                                {q.q.split('___').map((part, i, arr) => (
                                    <React.Fragment key={i}>
                                        {part}
                                        {i < arr.length - 1 && <span className="inline-block min-w-20 border-b-4 border-indigo-400 mx-1"></span>}
                                    </React.Fragment>
                                ))}
                            </h3>

                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-6">
                                {shuffledOptions.map((opt, i) => {
                                    const isCorrectAnswer = opt === q.a || (Array.isArray(q.a) && q.a.includes(opt));
                                    let btnClass = "bg-white border-2 border-slate-200 hover:border-indigo-400";

                                    if (answered) {
                                        if (isCorrectAnswer) btnClass = "bg-green-100 border-2 border-green-500";
                                        else if (opt === selectedOption) btnClass = "bg-red-100 border-2 border-red-400";
                                        else btnClass = "bg-slate-50 border-2 border-slate-100 opacity-50";
                                    }

                                    return (
                                        <button
                                            key={i}
                                            onClick={() => handleAnswer(opt)}
                                            disabled={answered}
                                            className={`p-4 rounded-xl font-medium text-left transition-all ${btnClass}`}
                                        >
                                            {opt}
                                        </button>
                                    );
                                })}
                            </div>

                            {answered && (
                                <div className="bg-indigo-50 rounded-xl p-4 border-l-4 border-indigo-500 mb-4 fade-in">
                                    <p className="font-bold text-indigo-900 mb-1">
                                        {selectedOption === q.a || (Array.isArray(q.a) && q.a.includes(selectedOption)) ? 'âœ“ Correct!' : 'Explanation:'}
                                    </p>
                                    <p className="text-indigo-800">{q.expl}</p>
                                </div>
                            )}

                            {!answered && (
                                <div className="flex justify-end mb-4">
                                    <Button onClick={handleSkip} variant="ghost" size="sm">
                                        Skip <Icon name="skip-forward" size={18} />
                                    </Button>
                                </div>
                            )}

                            {answered && (
                                <div className="flex justify-end">
                                    <Button onClick={next} variant="primary">
                                        {idx < activeQuestions.length - 1 ? 'Next' : 'View Results'} <Icon name="arrow-right" size={18} />
                                    </Button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- MODULE WRAPPER ---
        const ModuleWrapper = ({ title, subtitle, icon, color, children, onBack }) => (
            <div className="max-w-4xl w-full mx-auto p-4">
                <button onClick={onBack} className="mb-6 flex items-center gap-2 text-slate-500 hover:text-slate-700 transition-colors">
                    <Icon name="arrow-left" size={20} /> Back to Menu
                </button>

                <div className="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
                    <div className={`${color} p-6 sm:p-8`}>
                        <div className="flex items-center gap-4">
                            <div className="bg-white/20 p-3 rounded-xl">
                                <Icon name={icon} size={32} className="text-white" />
                            </div>
                            <div>
                                <h1 className="text-2xl sm:text-3xl font-black text-white">{title}</h1>
                                <p className="text-white/80">{subtitle}</p>
                            </div>
                        </div>
                    </div>
                    <div className="p-6 sm:p-8">
                        {children}
                    </div>
                </div>
            </div>
        );

        // --- MODULE 1: TYPES OF PHRASAL VERBS ---
        const Module1 = ({ initialState, onProgress, onComplete, onBack }) => {
            const [step, setStep] = useState(initialState?.step || 0);
            const [maxStepReached, setMaxStepReached] = useState(initialState?.maxStep || 0);
            const steps = ['Learn', 'Model', 'Check', 'Sort', 'Quiz'];

            // Track highest step reached and report to parent
            React.useEffect(() => {
                const newMax = Math.max(step, maxStepReached);
                if (newMax > maxStepReached) setMaxStepReached(newMax);
                if (onProgress) onProgress(step, newMax);
            }, [step, maxStepReached, onProgress]);

            const conceptQuestions = [
                { topic: "Adverbs", question: "What is an adverb?", options: ["A word that describes a verb", "A word that names a thing", "A word that joins sentences", "A word that shows time"], correctAnswer: "A word that describes a verb", explanation: "Adverbs describe HOW something happens. In phrasal verbs, words like 'up', 'down', 'away' are adverbs." },
                { topic: "Prepositions", question: "What is a preposition?", options: ["A word that links to a noun or pronoun", "A word that shows action", "A word that describes feelings", "A word that replaces names"], correctAnswer: "A word that links to a noun or pronoun", explanation: "Prepositions connect to objects. Words like 'for', 'into', 'with' are prepositions." },
                { topic: "Phrasal verb types", question: "'Stay up' has a verb + adverb. What about 'wait for'?", options: ["Verb + preposition", "Verb + adverb", "Verb + adverb + preposition", "Just a verb"], correctAnswer: "Verb + preposition", explanation: "'For' is a preposition that connects to an object (the bus, a friend, etc.)." },
                { topic: "Three-part phrasal verbs", question: "'Look forward to' has how many parts?", options: ["Three: verb + adverb + preposition", "Two: verb + adverb", "Two: verb + preposition", "One: just the verb"], correctAnswer: "Three: verb + adverb + preposition", explanation: "Look (verb) + forward (adverb) + to (preposition) = three parts." },
                { topic: "Unpredictable meanings", question: "Why must you memorize phrasal verbs?", options: ["The meaning often can't be guessed from the words", "They are always formal", "They have no grammar rules", "They only appear in writing"], correctAnswer: "The meaning often can't be guessed from the words", explanation: "'Call off' means 'cancel' - you can't guess this from 'call' + 'off'!" }
            ];

            const sortingItems = [
                { word: "stay up", category: "v+adv" },
                { word: "put away", category: "v+adv" },
                { word: "call off", category: "v+adv" },
                { word: "wait for", category: "v+prep" },
                { word: "bump into", category: "v+prep" },
                { word: "look after", category: "v+prep" },
                { word: "look forward to", category: "v+adv+prep" },
                { word: "get on with", category: "v+adv+prep" },
                { word: "put up with", category: "v+adv+prep" }
            ];

            const sortingCategories = [
                { id: "v+adv", name: "Verb + Adverb", icon: "zap", color: "bg-blue-50 border-blue-200 text-blue-800" },
                { id: "v+prep", name: "Verb + Preposition", icon: "link", color: "bg-green-50 border-green-200 text-green-800" },
                { id: "v+adv+prep", name: "Verb + Adv + Prep", icon: "layers", color: "bg-purple-50 border-purple-200 text-purple-800" }
            ];

            const renderContent = () => {
                switch (step) {
                    case 0: // Learn - clean, no concept checks
                        return (
                            <div className="space-y-6 fade-in">
                                <h2 className="text-2xl font-bold text-slate-800">What are Phrasal Verbs?</h2>
                                <p className="text-lg text-slate-600">
                                    Phrasal verbs are verbs made up of <strong>two or more words</strong>. They are very common in everyday English!
                                </p>

                                {/* Key terms box */}
                                <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-200">
                                    <h3 className="font-bold text-indigo-900 mb-3">Key Terms</h3>
                                    <div className="grid md:grid-cols-2 gap-3 text-sm">
                                        <div className="bg-white p-3 rounded-lg">
                                            <strong>Adverb:</strong> describes a verb (up, down, away, out)
                                        </div>
                                        <div className="bg-white p-3 rounded-lg">
                                            <strong>Preposition:</strong> links to a noun/pronoun (for, into, with)
                                        </div>
                                    </div>
                                </div>

                                {/* Type 1 */}
                                <div className="bg-blue-50 p-4 rounded-xl border border-blue-200">
                                    <h3 className="font-bold text-blue-900 mb-2">Type 1: Verb + Adverb</h3>
                                    <p className="text-blue-800 text-sm mb-2">The adverb changes the verb's meaning.</p>
                                    <div className="bg-white p-3 rounded-lg text-blue-900">
                                        "My brother <strong>stayed up</strong> all night." (stayed + up)
                                    </div>
                                </div>

                                {/* Type 2 */}
                                <div className="bg-green-50 p-4 rounded-xl border border-green-200">
                                    <h3 className="font-bold text-green-900 mb-2">Type 2: Verb + Preposition</h3>
                                    <p className="text-green-800 text-sm mb-2">The preposition connects to an object.</p>
                                    <div className="bg-white p-3 rounded-lg text-green-900">
                                        "Jeff has been <strong>waiting for</strong> the bus." (waiting + for)
                                    </div>
                                </div>

                                {/* Type 3 */}
                                <div className="bg-purple-50 p-4 rounded-xl border border-purple-200">
                                    <h3 className="font-bold text-purple-900 mb-2">Type 3: Verb + Adverb + Preposition</h3>
                                    <p className="text-purple-800 text-sm mb-2">Three-part phrasal verbs - the most complex!</p>
                                    <div className="bg-white p-3 rounded-lg text-purple-900">
                                        "Are you <strong>looking forward to</strong> the weekend?" (look + forward + to)
                                    </div>
                                </div>

                                {/* Important note */}
                                <div className="bg-amber-50 p-4 rounded-xl border border-amber-200">
                                    <p className="text-amber-800 text-sm">
                                        <strong>âš ï¸ Important:</strong> Phrasal verb meanings are often unpredictable.
                                        "Call off" means "cancel" - you can't guess this from the words!
                                    </p>
                                </div>

                                <div className="flex justify-end">
                                    <Button onClick={() => setStep(1)} variant="primary">
                                        See Examples <Icon name="arrow-right" size={18} />
                                    </Button>
                                </div>
                            </div>
                        );

                    case 1: // Model
                        return (
                            <div className="space-y-6 fade-in">
                                <TeacherModel title="Let's Identify Phrasal Verb Types Together" icon="users">
                                    <p className="mb-4">Watch how I break down each phrasal verb to identify its type:</p>

                                    <WorkedExample
                                        sentence="The barbecue was called off because of rain."
                                        parts={[
                                            { word: "called", type: "verb", label: "Verb" },
                                            { word: "off", type: "adverb", label: "Adverb" }
                                        ]}
                                        note="Verb + Adverb â†’ 'call off' means 'cancel'"
                                    />

                                    <WorkedExample
                                        sentence="Lily was talked into going to the party."
                                        parts={[
                                            { word: "talked", type: "verb", label: "Verb" },
                                            { word: "into", type: "preposition", label: "Preposition" }
                                        ]}
                                        note="Verb + Preposition â†’ 'talk into' means 'persuade'"
                                    />

                                    <WorkedExample
                                        sentence="Fiona doesn't get on with her sister."
                                        parts={[
                                            { word: "get", type: "verb", label: "Verb" },
                                            { word: "on", type: "adverb", label: "Adverb" },
                                            { word: "with", type: "preposition", label: "Preposition" }
                                        ]}
                                        note="Verb + Adverb + Preposition â†’ 'get on with' means 'have a good relationship with'"
                                    />
                                </TeacherModel>

                                <div className="bg-slate-100 p-5 rounded-xl">
                                    <h4 className="font-bold text-slate-700 mb-3 flex items-center gap-2">
                                        <Icon name="help-circle" size={20} /> How to identify the type:
                                    </h4>
                                    <ol className="space-y-2 text-slate-600">
                                        <li><strong>1.</strong> Find the main verb</li>
                                        <li><strong>2.</strong> Look at what follows - is it an adverb (up, down, off, away) or preposition (for, into, with)?</li>
                                        <li><strong>3.</strong> Count the parts: 2 parts or 3 parts?</li>
                                    </ol>
                                </div>

                                <div className="flex justify-between">
                                    <Button onClick={() => setStep(0)} variant="outline">
                                        <Icon name="arrow-left" size={18} /> Back
                                    </Button>
                                    <Button onClick={() => setStep(2)} variant="primary">
                                        Quick Check <Icon name="arrow-right" size={18} />
                                    </Button>
                                </div>
                            </div>
                        );

                    case 2: // Check - concept checks after examples
                        return (
                            <ConceptCheckStep
                                questions={conceptQuestions}
                                onComplete={() => setStep(3)}
                                onReviewRequest={() => setStep(0)}
                            />
                        );

                    case 3: // Sort
                        return (
                            <div className="space-y-6 fade-in">
                                <div className="text-center mb-6">
                                    <h3 className="text-xl font-bold text-slate-800 mb-2">Sorting Practice</h3>
                                    <p className="text-slate-600">Sort each phrasal verb into the correct category</p>
                                </div>

                                <SortingActivity
                                    items={sortingItems}
                                    categories={sortingCategories}
                                    onComplete={() => setStep(4)}
                                />

                                <div className="flex justify-start mt-4">
                                    <Button onClick={() => setStep(2)} variant="outline" size="sm">
                                        <Icon name="arrow-left" size={16} /> Back
                                    </Button>
                                </div>
                            </div>
                        );

                    case 4: // Quiz
                        return (
                            <div className="fade-in">
                                <QuizInterface
                                    questions={QUIZ_DATA.m1}
                                    title="Module 1 Quiz"
                                    onComplete={(score, total) => onComplete(score, total)}
                                />
                            </div>
                        );
                }
            };

            return (
                <ModuleWrapper
                    title="Types of Phrasal Verbs"
                    subtitle="Module 1: Understanding the three types"
                    icon="layers"
                    color="bg-gradient-to-r from-blue-600 to-indigo-600"
                    onBack={onBack}
                >
                    <StepIndicator steps={steps} current={step} maxReached={maxStepReached} onStepClick={setStep} />
                    {renderContent()}
                </ModuleWrapper>
            );
        };

        // --- MODULE 2: TRANSITIVE VS INTRANSITIVE ---
        const Module2 = ({ initialState, onProgress, onComplete, onBack }) => {
            const [step, setStep] = useState(initialState?.step || 0);
            const [maxStepReached, setMaxStepReached] = useState(initialState?.maxStep || 0);
            const steps = ['Learn', 'Model', 'Check', 'Practice', 'Quiz'];

            // Track highest step reached and report to parent
            React.useEffect(() => {
                const newMax = Math.max(step, maxStepReached);
                if (newMax > maxStepReached) setMaxStepReached(newMax);
                if (onProgress) onProgress(step, newMax);
            }, [step, maxStepReached, onProgress]);

            const conceptQuestions = [
                { topic: "Objects", question: "In 'I kicked the ball', what is the object?", options: ["the ball", "I", "kicked"], correctAnswer: "the ball", explanation: "The ball receives the action of kicking. Objects receive the action of the verb." },
                { topic: "Transitive", question: "'I ran into my friend.' - Does 'run into' need an object?", options: ["Yes, it needs an object", "No, it's complete alone", "It depends"], correctAnswer: "Yes, it needs an object", explanation: "You must say WHO you ran into. 'Run into' is transitive - it needs an object." },
                { topic: "Intransitive", question: "'I woke up early.' - Does 'wake up' need an object?", options: ["No, it's complete alone", "Yes, it needs an object", "It depends"], correctAnswer: "No, it's complete alone", explanation: "'Wake up' doesn't need an object. It's intransitive - complete on its own." },
                { topic: "Both types", question: "'The bomb blew up.' vs 'We blew up balloons.' - What's the difference?", options: ["First has no object, second has object", "First has object, second has no object", "Both are the same"], correctAnswer: "First has no object, second has object", explanation: "No object = intransitive (exploded). With object = transitive (inflated)." }
            ];

            const errorItems = [
                { sentence: "What time did you get up this morning?", hasError: false, errorType: "correct", explanation: "'Get up' is intransitive - it doesn't need an object. This is correct!" },
                { sentence: "I bumped into at the shops.", hasError: true, errorType: "wrong_order", explanation: "'Bump into' is transitive - it NEEDS an object. Who did you bump into?", correction: "I bumped into Sarah at the shops." },
                { sentence: "Jack works out every day.", hasError: false, errorType: "correct", explanation: "'Work out' (exercise) is intransitive - no object needed. Correct!" },
                { sentence: "Mr Ting blew up the balloons.", hasError: false, errorType: "correct", explanation: "'Blow up' (inflate) is transitive here and has an object (the balloons). Correct!" },
                { sentence: "Our car broke down it yesterday.", hasError: true, errorType: "wrong_separation", explanation: "'Break down' (stop working) is intransitive - it doesn't take an object!", correction: "Our car broke down yesterday." }
            ];

            const renderContent = () => {
                switch (step) {
                    case 0: // Learn - clean
                        return (
                            <div className="space-y-6 fade-in">
                                <h2 className="text-2xl font-bold text-slate-800">Transitive vs Intransitive</h2>
                                <p className="text-lg text-slate-600">
                                    Some phrasal verbs need an <strong>object</strong> (transitive), others don't (intransitive).
                                </p>

                                {/* Key terms */}
                                <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-200">
                                    <h3 className="font-bold text-indigo-900 mb-3">Key Terms</h3>
                                    <div className="grid md:grid-cols-3 gap-3 text-sm">
                                        <div className="bg-white p-3 rounded-lg">
                                            <strong>Object:</strong> receives the action (the ball, him, her)
                                        </div>
                                        <div className="bg-white p-3 rounded-lg">
                                            <strong>Transitive:</strong> needs an object
                                        </div>
                                        <div className="bg-white p-3 rounded-lg">
                                            <strong>Intransitive:</strong> no object needed
                                        </div>
                                    </div>
                                </div>

                                {/* Intransitive */}
                                <div className="bg-emerald-50 p-4 rounded-xl border border-emerald-200">
                                    <h3 className="font-bold text-emerald-900 mb-2">Intransitive (no object)</h3>
                                    <div className="space-y-2 text-sm">
                                        <div className="bg-white p-3 rounded-lg">"What time did you <strong>get up</strong>?" âœ“</div>
                                        <div className="bg-white p-3 rounded-lg">"Jack <strong>works out</strong> every day." âœ“</div>
                                    </div>
                                </div>

                                {/* Transitive */}
                                <div className="bg-sky-50 p-4 rounded-xl border border-sky-200">
                                    <h3 className="font-bold text-sky-900 mb-2">Transitive (needs object)</h3>
                                    <div className="space-y-2 text-sm">
                                        <div className="bg-white p-3 rounded-lg">"I <strong>bumped into</strong> <u>Roy</u>." âœ“</div>
                                        <div className="bg-white p-3 rounded-lg">"I'll <strong>clean up</strong> <u>the place</u>." âœ“</div>
                                    </div>
                                </div>

                                {/* Warning */}
                                <div className="bg-amber-50 p-4 rounded-xl border border-amber-200">
                                    <p className="text-amber-800 text-sm">
                                        <strong>âš ï¸ Tricky:</strong> Some can be both! "Blow up the balloons" (transitive) vs "Mr Ting blew up" (intransitive, = got angry)
                                    </p>
                                </div>

                                <div className="flex justify-end">
                                    <Button onClick={() => setStep(1)} variant="primary">
                                        See Examples <Icon name="arrow-right" size={18} />
                                    </Button>
                                </div>
                            </div>
                        );

                    case 1: // Model
                        return (
                            <div className="space-y-6 fade-in">
                                <TeacherModel title="Identifying Transitive & Intransitive" icon="search">
                                    <p className="mb-4">Ask yourself: "Does this phrasal verb need something/someone after it?"</p>

                                    <WorkedExample
                                        sentence="The car broke down yesterday."
                                        parts={[
                                            { word: "The car", type: "other", label: "Subject" },
                                            { word: "broke down", type: "verb", label: "Phrasal Verb" },
                                            { word: "yesterday", type: "other", label: "Time" }
                                        ]}
                                        note="No object! 'Broke down' is INTRANSITIVE here (= stopped working)"
                                    />

                                    <WorkedExample
                                        sentence="The police broke down the door."
                                        parts={[
                                            { word: "The police", type: "other", label: "Subject" },
                                            { word: "broke down", type: "verb", label: "Phrasal Verb" },
                                            { word: "the door", type: "object", label: "Object" }
                                        ]}
                                        note="Has an object! 'Broke down' is TRANSITIVE here (= destroyed)"
                                    />
                                </TeacherModel>

                                <div className="flex justify-between">
                                    <Button onClick={() => setStep(0)} variant="outline">
                                        <Icon name="arrow-left" size={18} /> Back
                                    </Button>
                                    <Button onClick={() => setStep(2)} variant="primary">
                                        Quick Check <Icon name="arrow-right" size={18} />
                                    </Button>
                                </div>
                            </div>
                        );

                    case 2: // Check
                        return (
                            <ConceptCheckStep
                                questions={conceptQuestions}
                                onComplete={() => setStep(3)}
                                onReviewRequest={() => setStep(0)}
                            />
                        );

                    case 3: // Practice
                        return (
                            <div className="space-y-6 fade-in">
                                <div className="text-center mb-4">
                                    <h3 className="text-xl font-bold text-slate-800">Error Correction Practice</h3>
                                    <p className="text-slate-600">Are these sentences correct? Identify any errors.</p>
                                </div>

                                <ErrorCorrectionActivity
                                    items={errorItems}
                                    onComplete={() => setStep(4)}
                                />
                            </div>
                        );

                    case 4: // Quiz
                        return (
                            <div className="fade-in">
                                <QuizInterface
                                    questions={QUIZ_DATA.m2}
                                    title="Module 2 Quiz"
                                    onComplete={(score, total) => onComplete(score, total)}
                                />
                            </div>
                        );
                }
            };

            return (
                <ModuleWrapper
                    title="Transitive & Intransitive"
                    subtitle="Module 2: Does the phrasal verb need an object?"
                    icon="git-branch"
                    color="bg-gradient-to-r from-emerald-600 to-teal-600"
                    onBack={onBack}
                >
                    <StepIndicator steps={steps} current={step} maxReached={maxStepReached} onStepClick={setStep} />
                    {renderContent()}
                </ModuleWrapper>
            );
        };

        // --- MODULE 3: SEPARABLE VS INSEPARABLE ---
        const Module3 = ({ initialState, onProgress, onComplete, onBack }) => {
            const [step, setStep] = useState(initialState?.step || 0);
            const [maxStepReached, setMaxStepReached] = useState(initialState?.maxStep || 0);
            const steps = ['Learn', 'Model', 'Check', 'Build', 'Quiz'];

            // Track highest step reached and report to parent
            React.useEffect(() => {
                const newMax = Math.max(step, maxStepReached);
                if (newMax > maxStepReached) setMaxStepReached(newMax);
                if (onProgress) onProgress(step, newMax);
            }, [step, maxStepReached, onProgress]);
            const conceptQuestions = [
                { topic: "Particles", question: "What is a 'particle' in a phrasal verb?", options: ["The adverb or preposition part", "The main verb", "The object", "The subject"], correctAnswer: "The adverb or preposition part", explanation: "In 'pick up', 'up' is the particle. It's the adverb/preposition attached to the verb." },
                { topic: "Separable verbs", question: "'Separable' means...", options: ["The object can go between verb and particle", "The verb can never be split", "It has three parts", "It needs no object"], correctAnswer: "The object can go between verb and particle", explanation: "Separable = we CAN put the object between: 'pick up the book' OR 'pick the book up'." },
                { topic: "Pronoun rule", question: "With pronouns, separable verbs MUST...", options: ["Be split: pick IT up, not pick up it", "Stay together: pick up it", "Change meaning", "Become formal"], correctAnswer: "Be split: pick IT up, not pick up it", explanation: "Pronouns go BETWEEN: 'pick it up' âœ“, 'pick up it' âœ—. This is a key rule!" },
                { topic: "Inseparable verbs", question: "'Inseparable' means...", options: ["Object can only go AFTER the whole verb", "Object can go in the middle", "Has no object", "Is always formal"], correctAnswer: "Object can only go AFTER the whole verb", explanation: "'Look after the cat' âœ“, 'look the cat after' âœ—. The phrasal verb stays together." }
            ];

            const sentenceItems = [
                { words: ["Can", "you", "pick", "them", "up", "?"], correct: ["Can you pick them up ?"], explanation: "With pronouns, separable verbs MUST be split: pick + them + up" },
                { words: ["Please", "look", "after", "my", "goldfish", "."], correct: ["Please look after my goldfish ."], explanation: "'Look after' is inseparable - the object comes after the whole phrasal verb" },
                { words: ["I", "can't", "put", "up", "with", "it", "."], correct: ["I can't put up with it ."], explanation: "Three-part phrasal verbs are NEVER separated" },
                { words: ["Tim", "asked", "Jenny", "out", "to", "dinner", "."], correct: ["Tim asked Jenny out to dinner ."], explanation: "'Ask out' MUST be separated - the object goes between" },
                { words: ["I'll", "show", "my", "friends", "around", "."], correct: ["I'll show my friends around ."], explanation: "'Show around' MUST be separated" }
            ];

            const renderContent = () => {
                switch (step) {
                    case 0: // Learn - clean
                        return (
                            <div className="space-y-6 fade-in">
                                <h2 className="text-2xl font-bold text-slate-800">Separable vs Inseparable</h2>
                                <p className="text-lg text-slate-600">
                                    Where does the <strong>object</strong> go? This is one of the trickiest parts!
                                </p>

                                {/* Key terms */}
                                <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-200">
                                    <h3 className="font-bold text-indigo-900 mb-3">Key Terms</h3>
                                    <div className="grid md:grid-cols-3 gap-3 text-sm">
                                        <div className="bg-white p-3 rounded-lg">
                                            <strong>Particle:</strong> the adverb/preposition part (up, down, after)
                                        </div>
                                        <div className="bg-white p-3 rounded-lg">
                                            <strong>Separable:</strong> object can go between
                                        </div>
                                        <div className="bg-white p-3 rounded-lg">
                                            <strong>Inseparable:</strong> object MUST go after
                                        </div>
                                    </div>
                                </div>

                                {/* Separable */}
                                <div className="bg-sky-50 p-4 rounded-xl border border-sky-200">
                                    <h3 className="font-bold text-sky-900 mb-2">Separable (verb + adverb)</h3>
                                    <p className="text-sky-800 text-sm mb-2">Object can go between OR after:</p>
                                    <div className="bg-white p-3 rounded-lg text-sm">
                                        <p>âœ“ "Pick <strong>up</strong> the book" OR "Pick the book <strong>up</strong>"</p>
                                        <p className="text-red-600 mt-2">âš ï¸ With pronouns: MUST split! "Pick <strong>it</strong> up" âœ“ "Pick up it" âœ—</p>
                                    </div>
                                </div>

                                {/* Inseparable */}
                                <div className="bg-orange-50 p-4 rounded-xl border border-orange-200">
                                    <h3 className="font-bold text-orange-900 mb-2">Inseparable (verb + preposition)</h3>
                                    <p className="text-orange-800 text-sm mb-2">Object MUST go after the whole phrasal verb:</p>
                                    <div className="bg-white p-3 rounded-lg text-sm">
                                        <p>âœ“ "Look <strong>after</strong> the baby" âœ— "Look the baby after"</p>
                                    </div>
                                </div>

                                {/* Must-separate */}
                                <div className="bg-amber-50 p-4 rounded-xl border border-amber-200">
                                    <p className="text-amber-800 text-sm">
                                        <strong>âš ï¸ Must-Separate:</strong> Some verbs REQUIRE the object between!<br />
                                        "Ask <strong>Jenny</strong> out" âœ“ "Ask out Jenny" âœ—
                                    </p>
                                </div>

                                <div className="flex justify-end">
                                    <Button onClick={() => setStep(1)} variant="primary">
                                        See Examples <Icon name="arrow-right" size={18} />
                                    </Button>
                                </div>
                            </div>
                        );

                    case 1:
                        return (
                            <div className="space-y-6 fade-in">
                                <TeacherModel title="Working Out Word Order" icon="move">
                                    <div className="space-y-4">
                                        <div className="bg-white p-4 rounded-xl">
                                            <p className="font-bold text-slate-700 mb-2">Example 1: "them" (pronoun)</p>
                                            <p className="text-slate-600 mb-2">Q: "Can you pick up them?"</p>
                                            <p className="text-red-600 mb-2">A: âœ— Wrong! Pronouns must go between.</p>
                                            <p className="text-green-700">âœ“ Correct: "Can you pick <strong>them</strong> up?"</p>
                                        </div>

                                        <div className="bg-white p-4 rounded-xl">
                                            <p className="font-bold text-slate-700 mb-2">Example 2: "my goldfish" (noun)</p>
                                            <p className="text-slate-600 mb-2">Q: Is "look after" separable?</p>
                                            <p className="text-slate-600 mb-2">A: No! It's verb + preposition, so inseparable.</p>
                                            <p className="text-green-700">âœ“ Correct: "Look after <strong>my goldfish</strong>."</p>
                                        </div>

                                        <div className="bg-white p-4 rounded-xl">
                                            <p className="font-bold text-slate-700 mb-2">Example 3: Three-part verb</p>
                                            <p className="text-slate-600 mb-2">Q: "I can't put it up with."</p>
                                            <p className="text-red-600 mb-2">A: âœ— Never separate three-part phrasal verbs!</p>
                                            <p className="text-green-700">âœ“ Correct: "I can't put up with <strong>it</strong>."</p>
                                        </div>
                                    </div>
                                </TeacherModel>

                                <div className="flex justify-between">
                                    <Button onClick={() => setStep(0)} variant="outline">
                                        <Icon name="arrow-left" size={18} /> Back
                                    </Button>
                                    <Button onClick={() => setStep(2)} variant="primary">
                                        Quick Check <Icon name="arrow-right" size={18} />
                                    </Button>
                                </div>
                            </div>
                        );

                    case 2: // Check
                        return (
                            <ConceptCheckStep
                                questions={conceptQuestions}
                                onComplete={() => setStep(3)}
                                onReviewRequest={() => setStep(0)}
                            />
                        );

                    case 3: // Build
                        return (
                            <div className="space-y-6 fade-in">
                                <div className="text-center mb-4">
                                    <h3 className="text-xl font-bold text-slate-800">Sentence Building</h3>
                                    <p className="text-slate-600">Arrange the words in the correct order</p>
                                </div>

                                <SentenceBuilderActivity
                                    items={sentenceItems}
                                    onComplete={() => setStep(4)}
                                />
                            </div>
                        );

                    case 4: // Quiz
                        return (
                            <div className="fade-in">
                                <QuizInterface
                                    questions={QUIZ_DATA.m3}
                                    title="Module 3 Quiz"
                                    onComplete={(score, total) => onComplete(score, total)}
                                />
                            </div>
                        );
                }
            };

            return (
                <ModuleWrapper
                    title="Separable vs Inseparable"
                    subtitle="Module 3: Where does the object go?"
                    icon="split"
                    color="bg-gradient-to-r from-violet-600 to-purple-600"
                    onBack={onBack}
                >
                    <StepIndicator steps={steps} current={step} maxReached={maxStepReached} onStepClick={setStep} />
                    {renderContent()}
                </ModuleWrapper>
            );
        };

        // --- MODULE 4: FORMAL VS INFORMAL ---
        const Module4 = ({ initialState, onProgress, onComplete, onBack }) => {
            const [step, setStep] = useState(initialState?.step || 0);
            const [maxStepReached, setMaxStepReached] = useState(initialState?.maxStep || 0);
            const steps = ['Learn', 'Model', 'Check', 'Match', 'Quiz'];

            // Track highest step reached and report to parent
            React.useEffect(() => {
                const newMax = Math.max(step, maxStepReached);
                if (newMax > maxStepReached) setMaxStepReached(newMax);
                if (onProgress) onProgress(step, newMax);
            }, [step, maxStepReached, onProgress]);

            const conceptQuestions = [
                { topic: "Register", question: "What is 'register' in language?", options: ["How formal or casual your words are", "The grammar of a sentence", "The spelling of words"], correctAnswer: "How formal or casual your words are", explanation: "Register = formality level. Essays need formal register, chatting needs informal." },
                { topic: "Phrasal verbs register", question: "Are phrasal verbs formal or informal?", options: ["Informal - for speaking/casual writing", "Formal - for essays", "Both equally"], correctAnswer: "Informal - for speaking/casual writing", explanation: "Phrasal verbs are informal. Use single-word verbs in essays and reports." },
                { topic: "Formal equivalents", question: "'Turn down' means the same as...", options: ["refuse", "cancel", "discover"], correctAnswer: "refuse", explanation: "'Turn down' = refuse. In an essay, write 'She refused the job' not 'She turned down the job'." }
            ];

            const matchingPairs = [
                { phrasal: "look into", formal: "investigate" },
                { phrasal: "find out", formal: "discover" },
                { phrasal: "turn down", formal: "refuse" },
                { phrasal: "sort out", formal: "resolve" },
                { phrasal: "call off", formal: "cancel" },
                { phrasal: "give up", formal: "quit" }
            ];

            const renderContent = () => {
                switch (step) {
                    case 0: // Learn - clean
                        return (
                            <div className="space-y-6 fade-in">
                                <h2 className="text-2xl font-bold text-slate-800">Formal vs Informal</h2>
                                <p className="text-lg text-slate-600">
                                    Phrasal verbs are <strong>informal</strong>. In formal writing, use single-word equivalents.
                                </p>

                                {/* Key terms */}
                                <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-200">
                                    <h3 className="font-bold text-indigo-900 mb-3">Key Term: Register</h3>
                                    <p className="text-sm text-slate-600">Register = the level of formality in your language.</p>
                                    <div className="grid md:grid-cols-2 gap-3 mt-3 text-sm">
                                        <div className="bg-white p-3 rounded-lg">
                                            <strong>Formal:</strong> essays, reports, official documents
                                        </div>
                                        <div className="bg-white p-3 rounded-lg">
                                            <strong>Informal:</strong> conversations, texts, casual emails
                                        </div>
                                    </div>
                                </div>

                                {/* Comparison */}
                                <div className="grid md:grid-cols-2 gap-4">
                                    <div className="bg-orange-50 p-4 rounded-xl border border-orange-200">
                                        <h3 className="font-bold text-orange-900 mb-2">Informal (Phrasal)</h3>
                                        <div className="space-y-1 text-sm">
                                            <p className="bg-white p-2 rounded">"<strong>Look into</strong> the case"</p>
                                            <p className="bg-white p-2 rounded">"<strong>Turn down</strong> the job"</p>
                                            <p className="bg-white p-2 rounded">"<strong>Sort out</strong> the problem"</p>
                                        </div>
                                    </div>
                                    <div className="bg-slate-100 p-4 rounded-xl border border-slate-200">
                                        <h3 className="font-bold text-slate-900 mb-2">Formal (Single-word)</h3>
                                        <div className="space-y-1 text-sm">
                                            <p className="bg-white p-2 rounded">"<strong>Investigate</strong> the case"</p>
                                            <p className="bg-white p-2 rounded">"<strong>Refuse</strong> the job"</p>
                                            <p className="bg-white p-2 rounded">"<strong>Resolve</strong> the problem"</p>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex justify-end">
                                    <Button onClick={() => setStep(1)} variant="primary">
                                        See Examples <Icon name="arrow-right" size={18} />
                                    </Button>
                                </div>
                            </div>
                        );

                    case 1: // Model
                        return (
                            <div className="space-y-6 fade-in">
                                <TeacherModel title="Choosing the Right Register" icon="toggle-left">
                                    <p className="mb-4">When should you use phrasal verbs vs formal verbs?</p>

                                    <div className="grid md:grid-cols-2 gap-4">
                                        <div className="bg-white p-4 rounded-xl">
                                            <p className="font-bold text-green-700 mb-2">âœ“ Use phrasal verbs:</p>
                                            <ul className="text-slate-600 text-sm space-y-1">
                                                <li>â€¢ Conversations</li>
                                                <li>â€¢ Casual emails</li>
                                                <li>â€¢ Text messages</li>
                                                <li>â€¢ Friendly letters</li>
                                            </ul>
                                        </div>
                                        <div className="bg-white p-4 rounded-xl">
                                            <p className="font-bold text-blue-700 mb-2">âœ“ Use formal verbs:</p>
                                            <ul className="text-slate-600 text-sm space-y-1">
                                                <li>â€¢ Academic essays</li>
                                                <li>â€¢ Business reports</li>
                                                <li>â€¢ Official letters</li>
                                                <li>â€¢ News articles</li>
                                            </ul>
                                        </div>
                                    </div>

                                    <div className="mt-4 p-4 bg-amber-50 rounded-xl">
                                        <p className="font-bold text-amber-800">Example transformation:</p>
                                        <p className="text-slate-700 mt-2">
                                            <span className="text-orange-600">Informal:</span> "You can <strong>find out</strong> more by visiting our website."
                                        </p>
                                        <p className="text-slate-700 mt-1">
                                            <span className="text-slate-600">Formal:</span> "People can <strong>discover</strong> more about the organisation by visiting their official website."
                                        </p>
                                    </div>
                                </TeacherModel>

                                <div className="flex justify-between">
                                    <Button onClick={() => setStep(0)} variant="outline">
                                        <Icon name="arrow-left" size={18} /> Back
                                    </Button>
                                    <Button onClick={() => setStep(2)} variant="primary">
                                        Quick Check <Icon name="arrow-right" size={18} />
                                    </Button>
                                </div>
                            </div>
                        );

                    case 2: // Check
                        return (
                            <ConceptCheckStep
                                questions={conceptQuestions}
                                onComplete={() => setStep(3)}
                                onReviewRequest={() => setStep(0)}
                            />
                        );

                    case 3: // Match
                        return (
                            <div className="space-y-6 fade-in">
                                <div className="text-center mb-4">
                                    <h3 className="text-xl font-bold text-slate-800">Matching Activity</h3>
                                    <p className="text-slate-600">Match phrasal verbs to their formal equivalents</p>
                                </div>

                                <MatchingActivity
                                    pairs={matchingPairs}
                                    onComplete={() => setStep(4)}
                                />
                            </div>
                        );


                    case 4: // Quiz
                        return (
                            <div className="fade-in">
                                <QuizInterface
                                    questions={QUIZ_DATA.m4}
                                    title="Module 4 Quiz"
                                    onComplete={(score, total) => onComplete(score, total)}
                                />
                            </div>
                        );
                }
            };

            return (
                <ModuleWrapper
                    title="Formal vs Informal"
                    subtitle="Module 4: Choosing the right register"
                    icon="toggle-left"
                    color="bg-gradient-to-r from-orange-500 to-amber-500"
                    onBack={onBack}
                >
                    <StepIndicator steps={steps} current={step} maxReached={maxStepReached} onStepClick={setStep} />
                    {renderContent()}
                </ModuleWrapper>
            );
        };

        // --- MODULE 5: COMMON ERRORS ---
        const Module5 = ({ initialState, onProgress, onComplete, onBack }) => {
            const [step, setStep] = useState(initialState?.step || 0);
            const [maxStepReached, setMaxStepReached] = useState(initialState?.maxStep || 0);
            const steps = ['Learn', 'Model', 'Check', 'Practice', 'Quiz'];

            // Track highest step reached and report to parent
            React.useEffect(() => {
                const newMax = Math.max(step, maxStepReached);
                if (newMax > maxStepReached) setMaxStepReached(newMax);
                if (onProgress) onProgress(step, newMax);
            }, [step, maxStepReached, onProgress]);

            const conceptQuestions = [
                { topic: "3-part verbs", question: "Can you split 'looking forward to'?", options: ["No - 3-part verbs NEVER split", "Yes - any verb can split", "Only with pronouns"], correctAnswer: "No - 3-part verbs NEVER split", explanation: "3-part phrasal verbs (verb + adverb + preposition) must stay together. Object goes after." },
                { topic: "Must-separate", question: "'Show around' - where does the object go?", options: ["Between 'show' and 'around'", "After 'around'", "Before 'show'"], correctAnswer: "Between 'show' and 'around'", explanation: "'Show around' is must-separate. Say 'show my friends around', NOT 'show around my friends'." },
                { topic: "Similar verbs", question: "To find a word in a dictionary, you...", options: ["look up", "look for", "look after"], correctAnswer: "look up", explanation: "'Look up' = search for information. 'Look for' = try to find something lost." }
            ];

            const errorItems = [
                { sentence: "I'm really looking forward our vacation to.", hasError: true, errorType: "wrong_order", explanation: "Three-part phrasal verbs cannot be separated!", correction: "I'm really looking forward to our vacation." },
                { sentence: "Sarah eventually gave up and bought her son a bicycle.", hasError: true, errorType: "wrong_verb", explanation: "'Give in' means to finally agree. 'Give up' means to stop doing something.", correction: "Sarah eventually gave in and bought her son a bicycle." },
                { sentence: "I'm looking for my keys.", hasError: false, errorType: "correct", explanation: "'Look for' means to try to find something. This is correct!" },
                { sentence: "Look the word for in your dictionary.", hasError: true, errorType: "wrong_verb", explanation: "'Look up' means to search for information. 'Look for' means to try to find something lost.", correction: "Look the word up in your dictionary." },
                { sentence: "I'm going to show around my friends my new house.", hasError: true, errorType: "wrong_separation", explanation: "'Show around' must be separated - the object goes between show and around.", correction: "I'm going to show my friends around my new house." }
            ];

            const renderContent = () => {
                switch (step) {
                    case 0: // Learn - clean
                        return (
                            <div className="space-y-6 fade-in">
                                <h2 className="text-2xl font-bold text-slate-800">Common Errors</h2>
                                <p className="text-lg text-slate-600">
                                    Avoid these common mistakes with phrasal verbs!
                                </p>

                                {/* Error 1 */}
                                <div className="bg-red-50 p-4 rounded-xl border border-red-200">
                                    <h3 className="font-bold text-red-900 mb-2">Error 1: Separating 3-part verbs</h3>
                                    <div className="bg-white p-3 rounded-lg text-sm">
                                        <p className="text-red-600">âœ— "I'm looking forward our vacation to."</p>
                                        <p className="text-green-700">âœ“ "I'm looking forward to our vacation."</p>
                                    </div>
                                </div>

                                {/* Error 2 */}
                                <div className="bg-red-50 p-4 rounded-xl border border-red-200">
                                    <h3 className="font-bold text-red-900 mb-2">Error 2: Not separating must-separate verbs</h3>
                                    <div className="bg-white p-3 rounded-lg text-sm">
                                        <p className="text-red-600">âœ— "Show around my friends."</p>
                                        <p className="text-green-700">âœ“ "Show my friends around."</p>
                                    </div>
                                </div>

                                {/* Error 3 */}
                                <div className="bg-red-50 p-4 rounded-xl border border-red-200">
                                    <h3 className="font-bold text-red-900 mb-2">Error 3: Confusing similar verbs</h3>
                                    <div className="grid md:grid-cols-2 gap-3 text-sm">
                                        <div className="bg-white p-3 rounded-lg">
                                            <p><strong>give in</strong> = finally agree</p>
                                            <p><strong>give up</strong> = stop doing</p>
                                        </div>
                                        <div className="bg-white p-3 rounded-lg">
                                            <p><strong>look for</strong> = find lost thing</p>
                                            <p><strong>look up</strong> = search info</p>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex justify-end">
                                    <Button onClick={() => setStep(1)} variant="primary">
                                        See Examples <Icon name="arrow-right" size={18} />
                                    </Button>
                                </div>
                            </div>
                        );

                    case 1: // Model
                        return (
                            <div className="space-y-6 fade-in">
                                <TeacherModel title="Spotting and Fixing Errors" icon="check-circle">
                                    <div className="space-y-4">
                                        <div className="bg-white p-4 rounded-xl">
                                            <p className="font-bold text-slate-700 mb-2">Example 1: "Lawrence gave in drinking."</p>
                                            <p className="text-slate-600 mb-2">Think: What does "give in" mean? (= finally agree)</p>
                                            <p className="text-slate-600 mb-2">Does that make sense? No! He stopped drinking.</p>
                                            <p className="text-green-700">âœ“ Fix: "Lawrence <strong>gave up</strong> drinking."</p>
                                        </div>

                                        <div className="bg-white p-4 rounded-xl">
                                            <p className="font-bold text-slate-700 mb-2">Example 2: "Look the word for in your dictionary."</p>
                                            <p className="text-slate-600 mb-2">Think: "Look for" = try to find something lost</p>
                                            <p className="text-slate-600 mb-2">Is the word lost? No! We're searching for information.</p>
                                            <p className="text-green-700">âœ“ Fix: "<strong>Look up</strong> the word in your dictionary."</p>
                                        </div>

                                        <div className="bg-white p-4 rounded-xl">
                                            <p className="font-bold text-slate-700 mb-2">Example 3: "I'm looking our trip forward to."</p>
                                            <p className="text-slate-600 mb-2">Think: "Look forward to" has 3 parts = NEVER separate!</p>
                                            <p className="text-green-700">âœ“ Fix: "I'm <strong>looking forward to</strong> our trip."</p>
                                        </div>
                                    </div>
                                </TeacherModel>

                                <div className="flex justify-between">
                                    <Button onClick={() => setStep(0)} variant="outline">
                                        <Icon name="arrow-left" size={18} /> Back
                                    </Button>
                                    <Button onClick={() => setStep(2)} variant="primary">
                                        Quick Check <Icon name="arrow-right" size={18} />
                                    </Button>
                                </div>
                            </div>
                        );

                    case 2: // Check
                        return (
                            <ConceptCheckStep
                                questions={conceptQuestions}
                                onComplete={() => setStep(3)}
                                onReviewRequest={() => setStep(0)}
                            />
                        );

                    case 3: // Practice
                        return (
                            <div className="space-y-6 fade-in">
                                <div className="text-center mb-4">
                                    <h3 className="text-xl font-bold text-slate-800">Error Identification</h3>
                                    <p className="text-slate-600">Find and identify the errors in these sentences</p>
                                </div>

                                <ErrorCorrectionActivity
                                    items={errorItems}
                                    onComplete={() => setStep(4)}
                                />
                            </div>
                        );

                    case 4: // Quiz
                        return (
                            <div className="fade-in">
                                <QuizInterface
                                    questions={QUIZ_DATA.m5}
                                    title="Module 5 Quiz"
                                    onComplete={(score, total) => onComplete(score, total)}
                                />
                            </div>
                        );
                }
            };

            return (
                <ModuleWrapper
                    title="Common Errors"
                    subtitle="Module 5: Avoid these mistakes!"
                    icon="alert-triangle"
                    color="bg-gradient-to-r from-red-500 to-rose-500"
                    onBack={onBack}
                >
                    <StepIndicator steps={steps} current={step} maxReached={maxStepReached} onStepClick={setStep} />
                    {renderContent()}
                </ModuleWrapper>
            );
        };

        // --- FINAL CHALLENGE ---
        const FinalChallenge = ({ onComplete, onBack }) => {
            // Generate 15 random questions from the pool on mount
            const questions = useMemo(() => generateTestQuestions(15), []);

            return (
                <ModuleWrapper
                    title="Final Challenge"
                    subtitle="Test your mastery of all phrasal verb rules!"
                    icon="trophy"
                    color="bg-gradient-to-r from-slate-800 to-slate-900"
                    onBack={onBack}
                >
                    <QuizInterface
                        questions={questions}
                        title="Final Challenge"
                        onComplete={(score, total) => onComplete(score, total)}
                    />
                </ModuleWrapper>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [screen, setScreen] = useState('menu');
            const [scores, setScores] = useState({});
            const [moduleProgress, setModuleProgress] = useState({
                m1: { step: 0, maxStep: 0 },
                m2: { step: 0, maxStep: 0 },
                m3: { step: 0, maxStep: 0 },
                m4: { step: 0, maxStep: 0 },
                m5: { step: 0, maxStep: 0 }
            });

            const handleComplete = (moduleId, score, total) => {
                setScores(prev => ({ ...prev, [moduleId]: { score, total } }));
                setScreen('menu');
            };

            const handleProgress = (moduleId, step, maxStep) => {
                setModuleProgress(prev => ({
                    ...prev,
                    [moduleId]: { step, maxStep: Math.max(maxStep, prev[moduleId]?.maxStep || 0) }
                }));
            };

            const modules = [
                { id: 'm1', title: "Types of Phrasal Verbs", desc: "Verb + adverb, verb + preposition, and three-part verbs", icon: "layers", color: "from-blue-500 to-indigo-500" },
                { id: 'm2', title: "Transitive & Intransitive", desc: "Does the phrasal verb need an object?", icon: "git-branch", color: "from-emerald-500 to-teal-500" },
                { id: 'm3', title: "Separable vs Inseparable", desc: "Where does the object go?", icon: "split", color: "from-violet-500 to-purple-500" },
                { id: 'm4', title: "Formal vs Informal", desc: "Phrasal verbs and their formal equivalents", icon: "toggle-left", color: "from-orange-500 to-amber-500" },
                { id: 'm5', title: "Common Errors", desc: "Avoid these frequent mistakes", icon: "alert-triangle", color: "from-red-500 to-rose-500" }
            ];

            if (screen === 'menu') {
                return (
                    <div className="min-h-screen p-4 sm:p-8">
                        <div className="max-w-4xl mx-auto">
                            <header className="text-center mb-12 fade-in">
                                <div className="inline-flex p-6 bg-indigo-100 text-indigo-600 rounded-full mb-6">
                                    <Icon name="book-open" size={64} />
                                </div>
                                <h1 className="text-4xl sm:text-5xl font-black text-slate-900 mb-3">Phrasal Verbs</h1>
                                <p className="text-xl text-slate-500">Unit 16 â€¢ Interactive Grammar Training</p>
                            </header>

                            <div className="space-y-4 mb-8">
                                {modules.map((mod, i) => (
                                    <button
                                        key={mod.id}
                                        onClick={() => setScreen(mod.id)}
                                        className="w-full bg-white p-5 rounded-2xl shadow-sm border-2 border-slate-100 hover:border-indigo-200 hover:shadow-lg transition-all text-left flex items-center gap-4 group fade-in"
                                        style={{ animationDelay: `${i * 0.1}s` }}
                                    >
                                        <div className={`bg-gradient-to-br ${mod.color} text-white p-4 rounded-xl shadow-lg group-hover:scale-110 transition-transform`}>
                                            <Icon name={mod.icon} size={28} />
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <h3 className="font-bold text-slate-800 text-lg">{i + 1}. {mod.title}</h3>
                                            <p className="text-slate-500 text-sm truncate">{mod.desc}</p>
                                        </div>
                                        {scores[mod.id] ? (
                                            <div className="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-bold">
                                                {scores[mod.id].score}/{scores[mod.id].total}
                                            </div>
                                        ) : (
                                            moduleProgress[mod.id]?.maxStep > 0 && (
                                                <div className="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full text-sm font-bold flex items-center gap-2">
                                                    <span className="w-2 h-2 rounded-full bg-indigo-500"></span>
                                                    Step {moduleProgress[mod.id].maxStep + 1}/5
                                                </div>
                                            )
                                        )}
                                        <Icon name="chevron-right" size={24} className="text-slate-300 group-hover:text-indigo-500 transition-colors" />
                                    </button>
                                ))}
                            </div>

                            <button
                                onClick={() => setScreen('final')}
                                className="w-full bg-gradient-to-r from-slate-800 to-slate-900 p-6 rounded-2xl shadow-xl text-white text-left flex items-center gap-4 hover:from-slate-700 hover:to-slate-800 transition-all group fade-in"
                            >
                                <div className="bg-yellow-500 text-slate-900 p-4 rounded-xl shadow-lg group-hover:scale-110 transition-transform">
                                    <Icon name="trophy" size={32} />
                                </div>
                                <div className="flex-1">
                                    <h3 className="font-black text-xl">Final Challenge</h3>
                                    <p className="text-slate-400">15 questions from all modules</p>
                                </div>
                                {scores['final'] && (
                                    <div className="bg-yellow-500 text-slate-900 px-4 py-2 rounded-full font-bold">
                                        {scores['final'].score}/{scores['final'].total}
                                    </div>
                                )}
                                <Icon name="arrow-right" size={28} className="text-slate-500 group-hover:text-white transition-colors" />
                            </button>

                            <footer className="text-center mt-12 text-slate-400">
                                S.3 English â€¢ Unit 16
                            </footer>
                        </div>
                    </div>
                );
            }

            const renderModule = () => {
                switch (screen) {
                    case 'm1': return <Module1 initialState={moduleProgress.m1} onProgress={(s, m) => handleProgress('m1', s, m)} onComplete={(s, t) => handleComplete('m1', s, t)} onBack={() => setScreen('menu')} />;
                    case 'm2': return <Module2 initialState={moduleProgress.m2} onProgress={(s, m) => handleProgress('m2', s, m)} onComplete={(s, t) => handleComplete('m2', s, t)} onBack={() => setScreen('menu')} />;
                    case 'm3': return <Module3 initialState={moduleProgress.m3} onProgress={(s, m) => handleProgress('m3', s, m)} onComplete={(s, t) => handleComplete('m3', s, t)} onBack={() => setScreen('menu')} />;
                    case 'm4': return <Module4 initialState={moduleProgress.m4} onProgress={(s, m) => handleProgress('m4', s, m)} onComplete={(s, t) => handleComplete('m4', s, t)} onBack={() => setScreen('menu')} />;
                    case 'm5': return <Module5 initialState={moduleProgress.m5} onProgress={(s, m) => handleProgress('m5', s, m)} onComplete={(s, t) => handleComplete('m5', s, t)} onBack={() => setScreen('menu')} />;
                    case 'final': return <FinalChallenge onComplete={(s, t) => handleComplete('final', s, t)} onBack={() => setScreen('menu')} />;
                    default: return null;
                }
            };

            return (
                <div className="min-h-screen py-8">
                    {renderModule()}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
