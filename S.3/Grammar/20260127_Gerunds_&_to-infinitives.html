<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerund & Infinitive Master</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-in-right {
            animation: slideInRight 0.3s ease-out forwards;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }
            
            75% {
                transform: translateX(5px);
            }
        }

        .pulse-success {
            animation: pulseSuccess 0.6s ease-out;
        }

        @keyframes pulseSuccess {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .drag-over {
            background-color: #e0e7ff !important;
            border-color: #6366f1 !important;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- ICON COMPONENT ---
        const Icon = ({ name, size = 28, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    ref.current.innerHTML = '';
                    const icon = document.createElement('i');
                    icon.setAttribute('data-lucide', name);
                    ref.current.appendChild(icon);
                    window.lucide.createIcons({
                        root: ref.current,
                        attrs: { width: size, height: size, class: className }
                    });
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center"></span>;
        };

        // --- DATA ---
        const VERB_DATA = {
            gerund: {
                verbs: ["admit", "avoid", "consider", "deny", "dislike", "enjoy", "finish", "imagine", "keep", "mind", "miss", "practise", "suggest"],
                examples: {
                    "admit": "He admitted stealing the money.",
                    "avoid": "Try to avoid hitting the curb.",
                    "consider": "We are considering moving to Canada.",
                    "deny": "She denied breaking the vase.",
                    "dislike": "I dislike waiting in line.",
                    "enjoy": "We enjoy playing chess.",
                    "finish": "Have you finished cleaning?",
                    "imagine": "Imagine living on the moon!",
                    "keep": "Keep trying your best!",
                    "mind": "Do you mind closing the window?",
                    "miss": "I miss chatting with you.",
                    "practise": "She practises playing piano daily.",
                    "suggest": "I suggest taking a taxi."
                }
            },
            infinitive: {
                verbs: ["agree", "choose", "decide", "hope", "learn", "need", "offer", "plan", "promise", "refuse", "seem", "want", "wish"],
                examples: {
                    "agree": "They agreed to help us.",
                    "choose": "I chose to stay home.",
                    "decide": "We decided to go out.",
                    "hope": "I hope to see you soon.",
                    "learn": "He is learning to drive.",
                    "need": "I need to buy milk.",
                    "offer": "She offered to drive me.",
                    "plan": "We plan to visit Italy.",
                    "promise": "He promised to call back.",
                    "refuse": "She refused to pay.",
                    "seem": "It seems to be broken.",
                    "want": "I want to be a doctor.",
                    "wish": "I wish to speak to the manager."
                }
            },
            objInfinitive: {
                verbs: ["advise", "allow", "ask", "enable", "encourage", "invite", "persuade", "remind", "teach", "tell", "warn"],
                examples: {
                    "advise": "He advised me to stop smoking.",
                    "allow": "They allowed us to enter.",
                    "ask": "She asked him to leave.",
                    "enable": "This tool enables you to work faster.",
                    "encourage": "He encouraged me to try again.",
                    "invite": "They invited us to stay.",
                    "persuade": "She persuaded him to go.",
                    "remind": "Remind me to call Mom.",
                    "teach": "He taught me to swim.",
                    "tell": "Tell him to wait here.",
                    "warn": "I warned you not to touch it."
                }
            },
            both: {
                verbs: ["begin", "continue", "hate", "like", "love", "prefer", "start"],
                examples: {
                    "begin": "It began raining. / It began to rain.",
                    "continue": "He continued talking. / He continued to talk.",
                    "hate": "I hate waiting. / I hate to wait.",
                    "like": "I like swimming. / I like to swim.",
                    "love": "I love reading. / I love to read.",
                    "prefer": "I prefer walking. / I prefer to walk.",
                    "start": "It started snowing. / It started to snow."
                }
            }
        };

        // --- UTILS ---
        const shuffleArray = (array) => {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        };

        // --- REUSABLE COMPONENTS ---
        const Button = ({ onClick, children, variant = "primary", className = "", disabled = false, size = "md" }) => {
            const styles = {
                primary: "bg-indigo-600 text-white hover:bg-indigo-700 shadow-md",
                secondary: "bg-white text-indigo-700 border-2 border-indigo-200 hover:bg-indigo-50",
                outline: "bg-transparent text-slate-600 border-2 border-slate-200 hover:bg-slate-100",
                success: "bg-emerald-600 text-white hover:bg-emerald-700 shadow-md",
                ghost: "bg-transparent text-slate-500 hover:bg-slate-100"
            };
            const sizes = {
                sm: "px-3 py-1.5 text-sm",
                md: "px-5 py-2.5 text-lg",
                lg: "px-8 py-4 text-xl"
            };
            return (
                <button
                    disabled={disabled}
                    onClick={onClick}
                    className={`rounded-xl font-bold transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:pointer-events-none active:scale-98 ${styles[variant]} ${sizes[size]} ${className}`}
                >
                    {children}
                </button>
            );
        };

        const ProgressBar = ({ current, total, color = "bg-indigo-500" }) => (
            <div className="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                <div className={`${color} h-full transition-all duration-500 ease-out`} style={{ width: `${(current / total) * 100}%` }}></div>
            </div>
        );

        // --- STEP INDICATOR ---
        const StepIndicator = ({ steps, current, maxReached, onStepClick }) => {
            return (
                <div className="flex items-center justify-center mb-8 px-4">
                    {steps.map((step, idx) => {
                        // Status: 0=locked, 1=current, 2=completed
                        const isCurrent = idx === current;
                        const isCompleted = idx < current;
                        const isAccessible = idx <= maxReached;

                        return (
                            <React.Fragment key={idx}>
                                {/* Step Circle */}
                                <button
                                    onClick={() => isAccessible && onStepClick(idx)}
                                    disabled={!isAccessible}
                                    className={`relative z-10 flex items-center justify-center p-2 sm:px-4 sm:py-2 rounded-full font-bold transition-all duration-300
                                        ${isCurrent ? 'bg-indigo-600 text-white shadow-lg scale-110' :
                                            isCompleted ? 'bg-emerald-500 text-white' :
                                                isAccessible ? 'bg-indigo-100 text-indigo-600 hover:bg-indigo-200' : 'bg-slate-100 text-slate-300'}`}
                                >
                                    {isCompleted ? (
                                        <Icon name="check" size={16} strokeWidth={3} />
                                    ) : (
                                        <span className="text-sm">{idx + 1}</span>
                                    )}
                                    <span className={`hidden sm:block ml-2 text-sm ${isCurrent ? 'opacity-100' : 'opacity-0'} transition-opacity duration-300`}>
                                        {step}
                                    </span>
                                </button>

                                {/* Connector Line */}
                                {idx < steps.length - 1 && (
                                    <div className={`h-1 flex-1 mx-2 rounded-full transition-all duration-500
                                        ${idx < maxReached ? 'bg-emerald-300' : 'bg-slate-100'}`}
                                    />
                                )}
                            </React.Fragment>
                        );
                    })}
                </div>
            );
        };

        const ConceptCheckStep = ({ questions, onComplete, onReviewRequest }) => {
            const [currentIdx, setCurrentIdx] = useState(0);
            const [showResult, setShowResult] = useState(false);
            const [selectedOption, setSelectedOption] = useState(null);
            const [mistakes, setMistakes] = useState([]);
            const [isReviewing, setIsReviewing] = useState(false);

            // Re-shuffle options when question changes
            const currentQ = questions[currentIdx];
            const shuffledOptions = useMemo(() => {
                return currentQ ? shuffleArray(currentQ.options) : [];
            }, [currentQ]);

            const handleSelect = (option) => {
                if (showResult) return;
                setSelectedOption(option);
                setShowResult(true);
            };

            const handleNext = () => {
                // If wrong, record mistake
                if (selectedOption !== currentQ.correctAnswer) {
                    setMistakes(prev => [...prev, currentQ]);
                }

                if (currentIdx < questions.length - 1) {
                    setCurrentIdx(prev => prev + 1);
                    setShowResult(false);
                    setSelectedOption(null);
                } else {
                    // Finished all questions
                    setIsReviewing(true);
                }
            };

            if (isReviewing) {
                const passed = mistakes.length === 0;
                return (
                    <div className="bg-white rounded-3xl shadow-xl overflow-hidden fade-in max-w-2xl mx-auto">
                        <div className={`p-8 text-center text-white ${passed ? 'bg-emerald-500' : 'bg-amber-500'}`}>
                            <Icon name={passed ? "check-circle" : "alert-circle"} size={64} className="mb-4 mx-auto" />
                            <h2 className="text-3xl font-black mb-2">{passed ? "Ready!" : "Review Suggestions"}</h2>
                            <p className="text-lg opacity-90">
                                {passed ? "You've grasped the key concepts. Ready to practice?" : `You missed ${mistakes.length} concept(s). A quick review might help!`}
                            </p>
                        </div>

                        <div className="p-8 space-y-4">
                            {!passed && (
                                <div className="bg-amber-50 p-4 rounded-xl border border-amber-100 text-left">
                                    <p className="font-bold text-amber-800 mb-2">concepts to review:</p>
                                    <ul className="list-disc list-inside space-y-1 text-amber-900">
                                        {mistakes.map((m, i) => (
                                            <li key={i}>{m.topic}</li>
                                        ))}
                                    </ul>
                                </div>
                            )}

                            <div className="flex gap-4">
                                {!passed && (
                                    <Button onClick={onReviewRequest} variant="outline" className="flex-1">
                                        <Icon name="arrow-left" size={20} /> Review Material
                                    </Button>
                                )}
                                <Button onClick={onComplete} variant="primary" className="flex-1">
                                    {passed ? "Start Practice" : "Continue Anyway"} <Icon name="arrow-right" size={20} />
                                </Button>
                            </div>
                        </div>
                    </div>
                );
            }

            const isCorrect = selectedOption === currentQ.correctAnswer;

            return (
                <div className="max-w-2xl mx-auto fade-in">
                    <div className="bg-white rounded-3xl shadow-xl overflow-hidden">
                        <div className="bg-indigo-50 p-6 border-b border-indigo-100 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="bg-indigo-100 p-2 rounded-lg">
                                    <Icon name="help-circle" size={24} className="text-indigo-600" />
                                </div>
                                <span className="font-bold text-indigo-900">Concept Check {currentIdx + 1}/{questions.length}</span>
                            </div>
                            <div className="text-sm font-bold text-indigo-400 uppercase tracking-wider">{currentQ.topic}</div>
                        </div>

                        <div className="p-8">
                            <h3 className="text-2xl font-bold text-slate-800 mb-6">{currentQ.question}</h3>

                            <div className="space-y-3">
                                {shuffledOptions.map((opt, i) => {
                                    let btnClass = "bg-white border-2 border-slate-200 text-slate-700 hover:border-indigo-300 hover:bg-slate-50";
                                    if (showResult) {
                                        if (opt === currentQ.correctAnswer) btnClass = "bg-emerald-100 border-emerald-500 text-emerald-800 font-bold";
                                        else if (opt === selectedOption) btnClass = "bg-red-100 border-red-500 text-red-800 opacity-60";
                                        else btnClass = "opacity-50 grayscale";
                                    }

                                    return (
                                        <button
                                            key={i}
                                            onClick={() => handleSelect(opt)}
                                            disabled={showResult}
                                            className={`w-full text-left p-4 rounded-xl transition-all duration-300 flex items-center justify-between group ${btnClass}`}
                                        >
                                            <span className="text-lg">{opt}</span>
                                            {showResult && opt === currentQ.correctAnswer && <Icon name="check" size={20} className="text-emerald-600" />}
                                            {showResult && opt === selectedOption && opt !== currentQ.correctAnswer && <Icon name="x" size={20} className="text-red-500" />}
                                        </button>
                                    );
                                })}
                            </div>

                            {showResult && (
                                <div className="mt-8 animate-in slide-in-from-bottom-4 duration-500">
                                    <div className={`p-4 rounded-xl mb-4 ${isCorrect ? 'bg-emerald-50 border border-emerald-100' : 'bg-amber-50 border border-amber-100'}`}>
                                        <div className="flex gap-3">
                                            <Icon name={isCorrect ? "check-circle" : "info"} size={24} className={isCorrect ? "text-emerald-500" : "text-amber-500"} />
                                            <div>
                                                <p className={`font-bold ${isCorrect ? 'text-emerald-900' : 'text-amber-900'}`}>{isCorrect ? "That's right!" : "Not quite."}</p>
                                                <p className="text-slate-700 mt-1">{currentQ.explanation}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <Button onClick={handleNext} variant={isCorrect ? "success" : "primary"} className="w-full">
                                        Continue <Icon name="arrow-right" size={20} />
                                    </Button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const WorkedExample = ({ label, sentence, highlights, explanation }) => (
            <div className="bg-white p-6 rounded-2xl border-2 border-slate-100 shadow-sm">
                <div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">{label}</div>
                <p className="text-2xl font-medium text-slate-800 mb-4" dangerouslySetInnerHTML={{ __html: sentence }}></p>
                {explanation && <p className="text-slate-600 bg-slate-50 p-4 rounded-xl"><Icon name="lightbulb" size={18} className="inline mr-2 text-amber-500" />{explanation}</p>}
            </div>
        );

        const InteractiveWordList = ({ words, examples, color = "indigo" }) => {
            const [selected, setSelected] = useState(null);
            const colors = {
                indigo: { bg: "bg-indigo-50", border: "border-indigo-500", text: "text-indigo-900", btnActive: "bg-indigo-600 text-white border-indigo-600" },
                emerald: { bg: "bg-emerald-50", border: "border-emerald-500", text: "text-emerald-900", btnActive: "bg-emerald-600 text-white border-emerald-600" },
                amber: { bg: "bg-amber-50", border: "border-amber-500", text: "text-amber-900", btnActive: "bg-amber-600 text-white border-amber-600" }
            };
            const c = colors[color];

            return (
                <div className="space-y-4">
                    <p className="text-slate-500 text-center flex items-center justify-center gap-2">
                        <Icon name="mouse-pointer-click" size={18} /> Tap any word to see an example
                    </p>
                    <div className="flex flex-wrap justify-center gap-2">
                        {words.map(word => (
                            <button
                                key={word}
                                onClick={() => setSelected(word)}
                                className={`px-4 py-2 rounded-lg font-bold border-2 transition-all ${selected === word ? c.btnActive + ' scale-105 shadow-lg' : 'bg-white text-slate-700 border-slate-200 hover:border-slate-300'}`}
                            >
                                {word}
                            </button>
                        ))}
                    </div>
                    {selected && (
                        <div className={`mt-4 p-5 ${c.bg} border-l-4 ${c.border} rounded-r-xl fade-in`}>
                            <p className={`text-xl font-medium ${c.text}`}>"{examples[selected]}"</p>
                        </div>
                    )}
                </div>
            );
        };

        // --- ACTIVITY COMPONENTS ---

        // Fill-in-the-blank with dropdown
        const FillBlankActivity = ({ sentences, onComplete }) => {
            const [answers, setAnswers] = useState({});
            const [showResults, setShowResults] = useState(false);
            const [currentIdx, setCurrentIdx] = useState(0);

            const handleSelect = (idx, value) => {
                setAnswers(prev => ({ ...prev, [idx]: value }));
            };

            const checkAnswers = () => {
                setShowResults(true);
            };

            const sentencesWithShuffledOptions = useMemo(() => {
                return sentences.map(s => ({
                    ...s,
                    options: shuffleArray(s.options)
                }));
            }, [sentences]);

            const allCorrect = sentences.every((s, i) => answers[i] === s.answer);
            const currentSentence = sentencesWithShuffledOptions[currentIdx];

            if (showResults) {
                const score = sentences.filter((s, i) => answers[i] === s.answer).length;
                return (
                    <div className="bg-white rounded-2xl p-8 shadow-lg fade-in">
                        <div className="text-center mb-6">
                            <div className={`inline-flex p-4 rounded-full mb-4 ${score === sentences.length ? 'bg-emerald-100' : 'bg-amber-100'}`}>
                                <Icon name={score === sentences.length ? "trophy" : "target"} size={48} className={score === sentences.length ? 'text-emerald-600' : 'text-amber-600'} />
                            </div>
                            <h3 className="text-2xl font-bold text-slate-800">{score}/{sentences.length} Correct</h3>
                        </div>
                        <div className="space-y-3 mb-6">
                            {sentences.map((s, i) => (
                                <div key={i} className={`p-4 rounded-xl flex items-start gap-3 ${answers[i] === s.answer ? 'bg-emerald-50' : 'bg-red-50'}`}>
                                    <Icon name={answers[i] === s.answer ? "check-circle" : "x-circle"} size={24} className={answers[i] === s.answer ? 'text-emerald-600' : 'text-red-500'} />
                                    <div>
                                        <p className="font-medium text-slate-800">{s.text.replace('___', `**${s.answer}**`).split('**').map((part, j) => j === 1 ? <strong key={j} className="text-indigo-600">{part}</strong> : part)}</p>
                                        {answers[i] !== s.answer && <p className="text-sm text-red-600 mt-1">You chose: {answers[i] || '(none)'}</p>}
                                    </div>
                                </div>
                            ))}
                        </div>
                        <Button onClick={onComplete} variant="primary" className="w-full">
                            {allCorrect ? "Continue" : "Try Again"} <Icon name="arrow-right" size={20} />
                        </Button>
                    </div>
                );
            }

            return (
                <div className="bg-white rounded-2xl p-6 shadow-lg fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <span className="text-slate-500 font-medium">Question {currentIdx + 1} of {sentences.length}</span>
                        <div className="flex gap-1">
                            {sentences.map((_, i) => (
                                <div key={i} className={`w-3 h-3 rounded-full ${answers[i] ? 'bg-indigo-500' : 'bg-slate-200'}`}></div>
                            ))}
                        </div>
                    </div>

                    <div className="mb-8">
                        <p className="text-2xl font-medium text-slate-800 leading-relaxed">
                            {currentSentence.text.split('___').map((part, i, arr) => (
                                <React.Fragment key={i}>
                                    {part}
                                    {i < arr.length - 1 && (
                                        <select
                                            value={answers[currentIdx] || ''}
                                            onChange={(e) => handleSelect(currentIdx, e.target.value)}
                                            className="mx-2 px-4 py-2 border-2 border-indigo-300 rounded-lg bg-indigo-50 text-indigo-700 font-bold focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        >
                                            <option value="">Choose...</option>
                                            {currentSentence.options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                        </select>
                                    )}
                                </React.Fragment>
                            ))}
                        </p>
                    </div>

                    <div className="flex gap-3">
                        <Button variant="outline" onClick={() => setCurrentIdx(Math.max(0, currentIdx - 1))} disabled={currentIdx === 0}>
                            <Icon name="arrow-left" size={20} />
                        </Button>
                        {currentIdx < sentences.length - 1 ? (
                            <Button variant="primary" onClick={() => setCurrentIdx(currentIdx + 1)} disabled={!answers[currentIdx]} className="flex-1">
                                Next <Icon name="arrow-right" size={20} />
                            </Button>
                        ) : (
                            <Button variant="success" onClick={checkAnswers} disabled={Object.keys(answers).length < sentences.length} className="flex-1">
                                Check Answers <Icon name="check" size={20} />
                            </Button>
                        )}
                    </div>
                </div>
            );
        };

        // Sorting/Categorization Activity
        const SortingActivity = ({ items, categories, onComplete }) => {
            const [placements, setPlacements] = useState({});
            const [showResults, setShowResults] = useState(false);
            const [draggedItem, setDraggedItem] = useState(null);

            // Calculate unplaced items
            const unplacedItems = items.filter(item => !Object.values(placements).flat().includes(item.word));

            const handleDragStart = (e, item) => {
                setDraggedItem(item);
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', item.word);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleDrop = (e, targetCategory) => {
                e.preventDefault();
                if (!draggedItem) return;

                const word = draggedItem.word;

                // Remove from any existing placement (if moved from one category to another)
                const newPlacements = { ...placements };
                Object.keys(newPlacements).forEach(cat => {
                    newPlacements[cat] = newPlacements[cat].filter(w => w !== word);
                });

                // Add to new category
                newPlacements[targetCategory] = [...(newPlacements[targetCategory] || []), word];

                setPlacements(newPlacements);
                setDraggedItem(null);
            };

            const handleDropToAvailable = (e) => {
                e.preventDefault();
                if (!draggedItem) return;

                const word = draggedItem.word;

                // Remove from any existing placement
                const newPlacements = { ...placements };
                Object.keys(newPlacements).forEach(cat => {
                    newPlacements[cat] = newPlacements[cat].filter(w => w !== word);
                });

                setPlacements(newPlacements);
                setDraggedItem(null);
            };

            const removeFromCategory = (category, word) => {
                setPlacements(prev => ({
                    ...prev,
                    [category]: prev[category].filter(w => w !== word)
                }));
            };

            const checkAnswers = () => setShowResults(true);

            const getScore = () => {
                let correct = 0;
                items.forEach(item => {
                    if (placements[item.category]?.includes(item.word)) correct++;
                });
                return correct;
            };

            const reset = () => {
                setPlacements({});
                setShowResults(false);
            }

            if (showResults) {
                const score = getScore();
                return (
                    <div className="bg-white rounded-2xl p-8 shadow-lg fade-in">
                        <div className="text-center mb-6">
                            <div className={`inline-flex p-4 rounded-full mb-4 ${score === items.length ? 'bg-emerald-100' : 'bg-amber-100'}`}>
                                <Icon name={score === items.length ? "trophy" : "target"} size={48} className={score === items.length ? 'text-emerald-600' : 'text-amber-600'} />
                            </div>
                            <h3 className="text-2xl font-bold text-slate-800">{score}/{items.length} Correct</h3>
                        </div>

                        <div className="grid grid-cols-2 gap-4 mb-6">
                            {categories.map(cat => (
                                <div key={cat.id} className={`p-4 rounded-xl ${cat.color}`}>
                                    <h4 className="font-bold mb-3">{cat.name}</h4>
                                    <div className="space-y-2">
                                        {items.filter(i => i.category === cat.id).map(item => (
                                            <div key={item.word} className={`px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2 ${placements[cat.id]?.includes(item.word) ? 'bg-emerald-100 text-emerald-800' : 'bg-red-100 text-red-800'}`}>
                                                <Icon name={placements[cat.id]?.includes(item.word) ? "check" : "x"} size={16} />
                                                {item.word}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="flex gap-3">
                            <Button onClick={reset} variant="outline" className="flex-1">
                                Try Again <Icon name="refresh-cw" size={20} />
                            </Button>
                            <Button onClick={onComplete} variant="primary" className="flex-1">
                                Continue <Icon name="arrow-right" size={20} />
                            </Button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="bg-white rounded-2xl p-6 shadow-lg fade-in">
                    <p className="text-slate-600 mb-4 text-center">
                        <Icon name="move" size={18} className="inline mr-2" />
                        Drag words to the correct category
                    </p>

                    {/* Unplaced items */}
                    <div
                        className={`bg-slate-100 rounded-xl p-4 mb-6 min-h-20 transition-colors ${draggedItem && !unplacedItems.includes(draggedItem) ? 'bg-indigo-50 border-2 border-indigo-200 border-dashed' : ''}`}
                        onDragOver={handleDragOver}
                        onDrop={handleDropToAvailable}
                    >
                        <div className="flex flex-wrap gap-2 justify-center">
                            {unplacedItems.map(item => (
                                <div
                                    key={item.word}
                                    draggable={true}
                                    onDragStart={(e) => handleDragStart(e, item)}
                                    className="px-4 py-2 bg-white rounded-lg font-bold shadow-sm cursor-grab active:cursor-grabbing hover:shadow-md hover:scale-105 transition-all select-none border border-slate-200 text-slate-700"
                                >
                                    {item.word}
                                </div>
                            ))}
                            {unplacedItems.length === 0 && <p className="text-slate-400 italic">All words sorted!</p>}
                        </div>
                    </div>

                    {/* Categories */}
                    <div className="grid grid-cols-2 gap-4 mb-6">
                        {categories.map(cat => (
                            <div
                                key={cat.id}
                                onDragOver={handleDragOver}
                                onDrop={(e) => handleDrop(e, cat.id)}
                                className={`p-4 rounded-xl border-2 border-dashed transition-all min-h-32 ${cat.color} ${draggedItem ? 'hover:bg-opacity-80 hover:scale-[1.02]' : ''}`}
                            >
                                <h4 className="font-bold text-lg mb-3 select-none pointer-events-none">{cat.name}</h4>
                                <div className="flex flex-wrap gap-2">
                                    {(placements[cat.id] || []).map(word => (
                                        <div
                                            key={word}
                                            draggable={true}
                                            onDragStart={(e) => handleDragStart(e, items.find(i => i.word === word))}
                                            className="px-3 py-1 bg-white rounded-lg text-sm font-medium shadow-sm cursor-grab active:cursor-grabbing hover:bg-slate-50 transition-colors flex items-center gap-1 select-none"
                                        >
                                            {word}
                                            <button
                                                onClick={(e) => { e.stopPropagation(); removeFromCategory(cat.id, word); }}
                                                className="ml-1 text-slate-400 hover:text-red-500 rounded-full"
                                            >
                                                <Icon name="x" size={14} />
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>

                    <Button
                        variant="success"
                        onClick={checkAnswers}
                        disabled={unplacedItems.length > 0}
                        className="w-full"
                    >
                        Check Answers <Icon name="check" size={20} />
                    </Button>
                </div>
            );
        };

        // Error Correction Activity
        const ErrorCorrectionActivity = ({ sentences, onComplete }) => {
            const [currentIdx, setCurrentIdx] = useState(0);
            const [userAnswers, setUserAnswers] = useState({});
            const [showFeedback, setShowFeedback] = useState(false);
            const [showResults, setShowResults] = useState(false);

            const current = sentences[currentIdx];

            const handleChoice = (choice) => {
                setUserAnswers(prev => ({ ...prev, [currentIdx]: choice }));
                setShowFeedback(true);
            };

            const nextQuestion = () => {
                setShowFeedback(false);
                if (currentIdx < sentences.length - 1) {
                    setCurrentIdx(currentIdx + 1);
                } else {
                    setShowResults(true);
                }
            };

            if (showResults) {
                const score = sentences.filter((s, i) => userAnswers[i] === s.correct).length;
                return (
                    <div className="bg-white rounded-2xl p-8 shadow-lg fade-in text-center">
                        <div className={`inline-flex p-4 rounded-full mb-4 ${score === sentences.length ? 'bg-emerald-100' : 'bg-amber-100'}`}>
                            <Icon name={score === sentences.length ? "trophy" : "target"} size={48} className={score === sentences.length ? 'text-emerald-600' : 'text-amber-600'} />
                        </div>
                        <h3 className="text-2xl font-bold text-slate-800 mb-6">{score}/{sentences.length} Correct</h3>
                        <Button onClick={onComplete} variant="primary" className="w-full">
                            Continue <Icon name="arrow-right" size={20} />
                        </Button>
                    </div>
                );
            }

            return (
                <div className="bg-white rounded-2xl p-6 shadow-lg fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <span className="text-slate-500 font-medium">Question {currentIdx + 1} of {sentences.length}</span>
                    </div>

                    <div className="bg-slate-50 p-6 rounded-xl mb-6">
                        <p className="text-sm text-slate-500 uppercase font-bold mb-2">Is this sentence correct?</p>
                        <p className="text-2xl font-medium text-slate-800">"{current.sentence}"</p>
                    </div>

                    {!showFeedback ? (
                        <div className="grid grid-cols-2 gap-4">
                            <Button variant="outline" onClick={() => handleChoice(true)} className="py-6 text-xl">
                                <Icon name="check" size={24} className="text-emerald-500" /> Correct
                            </Button>
                            <Button variant="outline" onClick={() => handleChoice(false)} className="py-6 text-xl">
                                <Icon name="x" size={24} className="text-red-500" /> Incorrect
                            </Button>
                        </div>
                    ) : (
                        <div className={`p-6 rounded-xl fade-in ${userAnswers[currentIdx] === current.correct ? 'bg-emerald-50 border-2 border-emerald-200' : 'bg-red-50 border-2 border-red-200'}`}>
                            <div className="flex items-center gap-3 mb-3">
                                <Icon name={userAnswers[currentIdx] === current.correct ? "check-circle" : "x-circle"} size={28} className={userAnswers[currentIdx] === current.correct ? 'text-emerald-600' : 'text-red-500'} />
                                <span className="font-bold text-lg">{userAnswers[currentIdx] === current.correct ? 'Correct!' : 'Not quite!'}</span>
                            </div>
                            <p className="text-slate-700 mb-2">{current.explanation}</p>
                            {!current.correct && <p className="font-medium text-emerald-700">Correct version: "{current.correction}"</p>}
                            <Button onClick={nextQuestion} variant="primary" className="w-full mt-4">
                                {currentIdx < sentences.length - 1 ? 'Next' : 'See Results'} <Icon name="arrow-right" size={20} />
                            </Button>
                        </div>
                    )}
                </div>
            );
        };

        // Sentence Building Activity
        const SentenceBuildingActivity = ({ prompts, onComplete }) => {
            const [currentIdx, setCurrentIdx] = useState(0);
            const [userInput, setUserInput] = useState('');
            const [showFeedback, setShowFeedback] = useState(false);
            const [results, setResults] = useState([]);

            const current = prompts[currentIdx];

            const checkAnswer = () => {
                const isCorrect = current.acceptedAnswers.some(ans =>
                    userInput.toLowerCase().trim() === ans.toLowerCase().trim()
                );
                setResults(prev => [...prev, { prompt: current, userAnswer: userInput, isCorrect }]);
                setShowFeedback(true);
            };

            const nextQuestion = () => {
                setShowFeedback(false);
                setUserInput('');
                if (currentIdx < prompts.length - 1) {
                    setCurrentIdx(currentIdx + 1);
                } else {
                    onComplete();
                }
            };

            return (
                <div className="bg-white rounded-2xl p-6 shadow-lg fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <span className="text-slate-500 font-medium">Sentence {currentIdx + 1} of {prompts.length}</span>
                    </div>

                    <div className="bg-indigo-50 p-6 rounded-xl mb-6">
                        <p className="text-sm text-indigo-600 uppercase font-bold mb-2">Complete the sentence using:</p>
                        <p className="text-xl font-bold text-indigo-900 mb-4">{current.verb} + {current.form}</p>
                        <p className="text-2xl font-medium text-slate-800">{current.start} ___</p>
                    </div>

                    {!showFeedback ? (
                        <>
                            <input
                                type="text"
                                value={userInput}
                                onChange={(e) => setUserInput(e.target.value)}
                                placeholder="Type the missing part..."
                                className="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-lg focus:outline-none focus:border-indigo-500 mb-4"
                                onKeyDown={(e) => e.key === 'Enter' && userInput && checkAnswer()}
                            />
                            <Button variant="primary" onClick={checkAnswer} disabled={!userInput} className="w-full">
                                Check <Icon name="check" size={20} />
                            </Button>
                        </>
                    ) : (
                        <div className={`p-6 rounded-xl fade-in ${results[results.length - 1].isCorrect ? 'bg-emerald-50' : 'bg-amber-50'}`}>
                            <div className="flex items-center gap-3 mb-3">
                                <Icon name={results[results.length - 1].isCorrect ? "check-circle" : "lightbulb"} size={28} className={results[results.length - 1].isCorrect ? 'text-emerald-600' : 'text-amber-600'} />
                                <span className="font-bold text-lg">{results[results.length - 1].isCorrect ? 'Perfect!' : 'Good try!'}</span>
                            </div>
                            <p className="text-slate-700">
                                <strong>Example answer:</strong> {current.start} <span className="text-emerald-600 font-bold">{current.acceptedAnswers[0]}</span>
                            </p>
                            <Button onClick={nextQuestion} variant="primary" className="w-full mt-4">
                                {currentIdx < prompts.length - 1 ? 'Next' : 'Finish'} <Icon name="arrow-right" size={20} />
                            </Button>
                        </div>
                    )}
                </div>
            );
        };

        // Quiz Component
        const QuizActivity = ({ questions, onComplete }) => {
            const [currentIdx, setCurrentIdx] = useState(0);
            const [answers, setAnswers] = useState({});
            const [showFeedback, setShowFeedback] = useState(false);
            const [showResults, setShowResults] = useState(false);

            const questionsWithShuffledOptions = useMemo(() => {
                return questions.map(q => ({
                    ...q,
                    options: shuffleArray(q.options)
                }));
            }, [questions]);

            const q = questionsWithShuffledOptions[currentIdx];

            const handleAnswer = (choice) => {
                if (showFeedback) return;
                setAnswers(prev => ({ ...prev, [currentIdx]: choice }));
                setShowFeedback(true);
            };

            const nextQuestion = () => {
                setShowFeedback(false);
                if (currentIdx < questions.length - 1) {
                    setCurrentIdx(currentIdx + 1);
                } else {
                    setShowResults(true);
                }
            };

            if (showResults) {
                const score = questions.filter((q, i) => answers[i] === q.answer).length;
                const mistakes = questions.filter((q, i) => answers[i] !== q.answer);

                return (
                    <div className="bg-white rounded-2xl shadow-lg overflow-hidden fade-in">
                        <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-8 text-center text-white">
                            <div className="text-6xl font-black mb-2">{score}/{questions.length}</div>
                            <p className="text-xl text-indigo-100">{score === questions.length ? 'Perfect score!' : 'Keep practicing!'}</p>
                        </div>

                        {mistakes.length > 0 && (
                            <div className="p-6">
                                <h4 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                    <Icon name="book-open" size={20} /> Review these:
                                </h4>
                                <div className="space-y-3">
                                    {mistakes.map((m, i) => (
                                        <div key={i} className="bg-red-50 p-4 rounded-xl">
                                            <p className="font-medium text-slate-800 mb-2">{m.question}</p>
                                            <p className="text-sm text-emerald-700">Answer: <strong>{m.answer}</strong></p>
                                            <p className="text-sm text-slate-600 mt-2">{m.explanation}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        <div className="p-6 bg-slate-50">
                            <Button onClick={() => onComplete(score, questions.length)} variant="primary" className="w-full">
                                Continue <Icon name="arrow-right" size={20} />
                            </Button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="bg-white rounded-2xl p-6 shadow-lg fade-in">
                    <ProgressBar current={currentIdx + 1} total={questions.length} />

                    <div className="py-8">
                        <p className="text-sm text-slate-500 mb-2">Question {currentIdx + 1} of {questions.length}</p>
                        <h3 className="text-2xl font-bold text-slate-800 mb-8">
                            {q.question.split('___').map((part, i, arr) => (
                                <React.Fragment key={i}>
                                    {part}
                                    {i < arr.length - 1 && <span className="inline-block w-24 border-b-2 border-indigo-400 mx-1"></span>}
                                </React.Fragment>
                            ))}
                        </h3>

                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            {q.options.map((opt, i) => {
                                let style = "bg-white border-2 border-slate-200 hover:border-indigo-300";
                                if (showFeedback) {
                                    if (opt === q.answer) style = "bg-emerald-100 border-2 border-emerald-500";
                                    else if (opt === answers[currentIdx]) style = "bg-red-50 border-2 border-red-300";
                                    else style = "bg-slate-50 border-2 border-slate-100 opacity-50";
                                }
                                return (
                                    <button
                                        key={i}
                                        onClick={() => handleAnswer(opt)}
                                        disabled={showFeedback}
                                        className={`p-4 rounded-xl font-medium text-left transition-all ${style}`}
                                    >
                                        {opt}
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {showFeedback && (
                        <div className={`p-4 rounded-xl mb-4 fade-in ${answers[currentIdx] === q.answer ? 'bg-emerald-50' : 'bg-amber-50'}`}>
                            <p className="font-medium text-slate-700">{q.explanation}</p>
                        </div>
                    )}

                    {showFeedback && (
                        <Button onClick={nextQuestion} variant="primary" className="w-full">
                            {currentIdx < questions.length - 1 ? 'Next Question' : 'See Results'} <Icon name="arrow-right" size={20} />
                        </Button>
                    )}
                </div>
            );
        };

        // --- MODULE CONTENT ---
        const MODULE_DATA = {
            m1: {
                title: "The Gerund (-ing)",
                icon: "pen-tool",
                color: "emerald",
                phases: [
                    { id: 'learn', name: 'Learn' },
                    { id: 'guided', name: 'Guided Practice' },
                    { id: 'practice', name: 'Independent Practice' }
                ],
                learnSlides: [
                    {
                        title: "What is a Gerund?",
                        content: (
                            <div className="space-y-6">
                                <div className="bg-emerald-50 p-6 rounded-2xl border-l-4 border-emerald-500">
                                    <p className="text-xl font-medium text-emerald-900">A <strong>gerund</strong> is the <strong>-ing</strong> form of a verb used as a noun.</p>
                                </div>
                                <WorkedExample
                                    label="Example: Gerund as Subject"
                                    sentence="<span class='text-emerald-600 font-bold'>Swimming</span> is good exercise."
                                    explanation="'Swimming' is a verb form, but here it acts as the subject noun."
                                />
                                <WorkedExample
                                    label="Example: Go + Gerund"
                                    sentence="Would you like to go <span class='text-emerald-600 font-bold'>camping</span>?"
                                    explanation="We use 'go + gerund' for many activities: go shopping, go fishing, go hiking."
                                />
                                <div className="bg-amber-50 p-4 rounded-xl border-l-4 border-amber-400">
                                    <p className="font-bold text-amber-800 flex items-center gap-2"><Icon name="alert-triangle" size={20} /> Key Rule</p>
                                    <p className="text-amber-700">When a gerund is the subject, use a <strong>singular verb</strong>: "Swimming <u>is</u> fun" (not "are").</p>
                                </div>
                            </div>
                        )
                    },
                    {
                        title: "Verbs Followed by Gerunds",
                        content: (
                            <div className="space-y-6">
                                <p className="text-lg text-slate-700">Some verbs are <strong>always</strong> followed by a gerund. You must memorize these!</p>
                                <InteractiveWordList words={VERB_DATA.gerund.verbs} examples={VERB_DATA.gerund.examples} color="emerald" />
                                <div className="bg-slate-50 p-4 rounded-xl">
                                    <p className="font-bold text-slate-700 mb-2">Pattern:</p>
                                    <p className="text-xl font-mono text-center py-2">VERB + <span className="bg-emerald-200 px-2 rounded">GERUND (-ing)</span></p>
                                </div>
                            </div>
                        )
                    },
                    {
                        title: "Gerunds After Prepositions",
                        content: (
                            <div className="space-y-6">
                                <div className="bg-emerald-50 p-6 rounded-2xl">
                                    <p className="text-xl font-medium text-emerald-900">After prepositions (by, in, at, for, about, etc.), always use a gerund.</p>
                                </div>
                                <WorkedExample
                                    label="After Preposition"
                                    sentence="Are you interested <span class='text-sky-600 font-bold'>in</span> <span class='text-emerald-600 font-bold'>joining</span> this course?"
                                />
                                <WorkedExample
                                    label="After Phrasal Verb"
                                    sentence="My father decided to give <span class='text-sky-600 font-bold'>up</span> <span class='text-emerald-600 font-bold'>smoking</span>."
                                    explanation="Phrasal verbs like 'give up', 'look forward to', 'think about' are followed by gerunds."
                                />
                            </div>
                        )
                    },
                    {
                        title: "Be/Get Used To + Gerund",
                        content: (
                            <div className="space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-amber-50 p-5 rounded-2xl border-2 border-amber-200">
                                        <div className="bg-amber-200 text-amber-900 px-3 py-1 rounded-lg inline-block mb-3 text-sm font-bold">PAST HABIT</div>
                                        <h4 className="text-xl font-bold text-amber-900 mb-2">used to + BASE VERB</h4>
                                        <p className="text-amber-800 mb-3">Something you did before but don't do now.</p>
                                        <div className="bg-white p-3 rounded-xl">
                                            <p className="font-medium">"I <strong>used to walk</strong> to school."</p>
                                            <p className="text-sm text-amber-600">(I don't walk now)</p>
                                        </div>
                                    </div>
                                    <div className="bg-emerald-50 p-5 rounded-2xl border-2 border-emerald-200">
                                        <div className="bg-emerald-200 text-emerald-900 px-3 py-1 rounded-lg inline-block mb-3 text-sm font-bold">FAMILIARITY</div>
                                        <h4 className="text-xl font-bold text-emerald-900 mb-2">be/get used to + GERUND</h4>
                                        <p className="text-emerald-800 mb-3">Something normal/familiar to you.</p>
                                        <div className="bg-white p-3 rounded-xl">
                                            <p className="font-medium">"I <strong>am used to walking</strong>."</p>
                                            <p className="text-sm text-emerald-600">(It's normal for me)</p>
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-red-50 p-4 rounded-xl border-l-4 border-red-400">
                                    <p className="font-bold text-red-800 flex items-center gap-2"><Icon name="x-circle" size={20} /> Common Error</p>
                                    <p className="text-red-700">Don't mix them up! "I am used to walk" is WRONG.</p>
                                </div>
                            </div>
                        )
                    }
                ],
                guidedActivities: [
                    {
                        type: 'teacherModel',
                        title: "Teacher Model: Identifying Gerunds",
                        content: (
                            <div className="space-y-6">
                                <div className="bg-indigo-50 p-6 rounded-2xl">
                                    <p className="text-indigo-700 font-medium mb-4">Watch how we identify whether to use a gerund:</p>
                                    <div className="bg-white p-4 rounded-xl mb-4">
                                        <p className="text-lg mb-2"><strong>Sentence:</strong> "Do you mind ___ the door?"</p>
                                        <div className="pl-4 border-l-4 border-indigo-300 space-y-2 mt-4">
                                            <p>Step 1: What's the main verb?  <strong>mind</strong></p>
                                            <p>Step 2: Check: Is "mind" in the gerund list?  <strong>Yes!</strong></p>
                                            <p>Step 3: Use the gerund form  <strong>closing</strong></p>
                                        </div>
                                    </div>
                                    <div className="bg-emerald-100 p-4 rounded-xl">
                                        <p className="text-emerald-800 font-medium">Answer: "Do you mind <strong>closing</strong> the door?"</p>
                                    </div>
                                </div>
                            </div>
                        )
                    },
                    {
                        type: 'sorting',
                        title: "Sort the Verbs",
                        items: [
                            { word: "enjoy", category: "gerund" },
                            { word: "want", category: "infinitive" },
                            { word: "mind", category: "gerund" },
                            { word: "decide", category: "infinitive" },
                            { word: "avoid", category: "gerund" },
                            { word: "hope", category: "infinitive" },
                            { word: "finish", category: "gerund" },
                            { word: "plan", category: "infinitive" }
                        ],
                        categories: [
                            { id: "gerund", name: "Always + Gerund", color: "bg-emerald-50" },
                            { id: "infinitive", name: "Always + To-infinitive", color: "bg-sky-50" }
                        ]
                    },
                    {
                        type: 'fillBlank',
                        title: "Complete the Sentences",
                        sentences: [
                            { text: "I enjoy ___ to music while studying.", options: ["to listen", "listening", "listen"], answer: "listening" },
                            { text: "Have you finished ___ your homework?", options: ["to do", "do", "doing"], answer: "doing" },
                            { text: "She suggested ___ a movie tonight.", options: ["watch", "watching", "to watch"], answer: "watching" },
                            { text: "I can't imagine ___ in such a cold place.", options: ["to live", "live", "living"], answer: "living" }
                        ]
                    }
                ],
                practiceQuestions: [
                    { question: "___ is my favourite hobby.", options: ["To read", "Reading", "Read", "Reads"], answer: "Reading", explanation: "When a verb acts as the subject, use the gerund form." },
                    { question: "Do you mind ___ me with this?", options: ["to help", "help", "helping", "helped"], answer: "helping", explanation: "'Mind' is always followed by a gerund." },
                    { question: "She admitted ___ the window.", options: ["break", "breaking", "to break", "broken"], answer: "breaking", explanation: "'Admit' is always followed by a gerund." },
                    { question: "Are you interested in ___ Spanish?", options: ["to learn", "learn", "learning", "learned"], answer: "learning", explanation: "After prepositions (in, by, at), we use gerunds." },
                    { question: "I ___ walk to school, but now I take the bus.", options: ["am used to", "used to", "get used to", "using to"], answer: "used to", explanation: "'Used to + base verb' describes a past habit that no longer happens." },
                    { question: "After living here for years, I ___ the noise.", options: ["used to", "use to", "am used to", "am use to"], answer: "am used to", explanation: "'Be used to' + gerund/noun means something is familiar." },
                    { question: "He keeps ___ the same mistakes.", options: ["making", "to make", "make", "made"], answer: "making", explanation: "'Keep' is always followed by a gerund." },
                    { question: "We considered ___ to a bigger house.", options: ["to move", "move", "moving", "moved"], answer: "moving", explanation: "'Consider' is always followed by a gerund." }
                ]
            },
            m2: {
                title: "To-Infinitives",
                icon: "terminal",
                color: "sky",
                phases: [
                    { id: 'learn', name: 'Learn' },
                    { id: 'guided', name: 'Guided Practice' },
                    { id: 'practice', name: 'Independent Practice' }
                ],
                learnSlides: [
                    {
                        title: "What is a To-Infinitive?",
                        content: (
                            <div className="space-y-6">
                                <div className="bg-sky-50 p-6 rounded-2xl border-l-4 border-sky-500">
                                    <p className="text-xl font-medium text-sky-900">A <strong>to-infinitive</strong> is <strong>to + base form</strong> of a verb.</p>
                                </div>
                                <WorkedExample
                                    label="Basic Pattern"
                                    sentence="I <span class='text-slate-600'>want</span> <span class='text-sky-600 font-bold'>to learn</span> French."
                                    explanation="After 'want', we use the to-infinitive form."
                                />
                                <InteractiveWordList words={VERB_DATA.infinitive.verbs} examples={VERB_DATA.infinitive.examples} color="indigo" />
                            </div>
                        )
                    },
                    {
                        title: "Verb + Object + To-Infinitive",
                        content: (
                            <div className="space-y-6">
                                <div className="bg-sky-50 p-6 rounded-2xl">
                                    <p className="text-xl font-medium text-sky-900">Some verbs need an <strong>object</strong> (a person) before the to-infinitive.</p>
                                </div>
                                <WorkedExample
                                    label="With Object"
                                    sentence="The teacher encouraged <span class='text-purple-600 font-bold'>her</span> <span class='text-sky-600 font-bold'>to try again</span>."
                                    explanation="'Encouraged' needs to say WHO was encouraged (her) before the action."
                                />
                                <InteractiveWordList words={VERB_DATA.objInfinitive.verbs} examples={VERB_DATA.objInfinitive.examples} color="indigo" />
                                <div className="bg-slate-50 p-4 rounded-xl">
                                    <p className="font-bold text-slate-700 mb-2">Pattern:</p>
                                    <p className="text-xl font-mono text-center py-2">VERB + <span className="bg-purple-200 px-2 rounded">OBJECT</span> + <span className="bg-sky-200 px-2 rounded">TO-INFINITIVE</span></p>
                                </div>
                            </div>
                        )
                    },
                    {
                        title: "After Adjectives & Wh-words",
                        content: (
                            <div className="space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-pink-50 p-5 rounded-2xl">
                                        <h4 className="font-bold text-pink-900 mb-3 flex items-center gap-2"><Icon name="heart" size={20} /> After Adjectives</h4>
                                        <p className="text-pink-800 mb-3">Especially feelings: glad, happy, nice, surprised...</p>
                                        <div className="bg-white p-3 rounded-xl">
                                            <p>"It's <strong>nice to meet</strong> you."</p>
                                            <p>"I'm <strong>glad to hear</strong> that."</p>
                                        </div>
                                    </div>
                                    <div className="bg-blue-50 p-5 rounded-2xl">
                                        <h4 className="font-bold text-blue-900 mb-3 flex items-center gap-2"><Icon name="help-circle" size={20} /> After Wh-words</h4>
                                        <p className="text-blue-800 mb-3">what, where, how, when (NOT why)</p>
                                        <div className="bg-white p-3 rounded-xl">
                                            <p>"I know <strong>how to swim</strong>."</p>
                                            <p>"Tell me <strong>what to do</strong>."</p>
                                        </div>
                                    </div>
                                </div>
                                <WorkedExample
                                    label="After Nouns/Pronouns"
                                    sentence="I have <span class='text-amber-600 font-bold'>something</span> <span class='text-sky-600 font-bold'>to tell</span> you."
                                    explanation="To-infinitives also follow nouns (time, way, something, anything, etc.)"
                                />
                            </div>
                        )
                    },
                    {
                        title: "Negative To-Infinitives",
                        content: (
                            <div className="space-y-6">
                                <div className="bg-sky-50 p-6 rounded-2xl border-l-4 border-sky-500">
                                    <p className="text-xl font-medium text-sky-900">The negative form is: <strong>not + to-infinitive</strong></p>
                                </div>
                                <WorkedExample
                                    label="Negative Infinitive"
                                    sentence="He promised <span class='text-red-600 font-bold'>not to</span> <span class='text-sky-600 font-bold'>be</span> late again."
                                />
                                <WorkedExample
                                    label="With Object"
                                    sentence="Mum told me <span class='text-red-600 font-bold'>not to</span> <span class='text-sky-600 font-bold'>talk</span> to strangers."
                                />
                                <div className="bg-red-50 p-4 rounded-xl border-l-4 border-red-400">
                                    <p className="font-bold text-red-800 flex items-center gap-2"><Icon name="x-circle" size={20} /> Common Error</p>
                                    <p className="text-red-700">"to not do" is generally considered incorrect. Use "not to do".</p>
                                </div>
                            </div>
                        )
                    }
                ],
                guidedActivities: [
                    {
                        type: 'teacherModel',
                        title: "Teacher Model: Verb + Object Pattern",
                        content: (
                            <div className="space-y-6">
                                <div className="bg-indigo-50 p-6 rounded-2xl">
                                    <p className="text-indigo-700 font-medium mb-4">Let's work through an example together:</p>
                                    <div className="bg-white p-4 rounded-xl mb-4">
                                        <p className="text-lg mb-2"><strong>Task:</strong> Complete with "advise"</p>
                                        <p className="text-lg">"The doctor ___ her ___ more water."</p>
                                        <div className="pl-4 border-l-4 border-indigo-300 space-y-2 mt-4">
                                            <p>Step 1: "Advise" needs an object (who is being advised?)  <strong>her</strong></p>
                                            <p>Step 2: After the object, use to-infinitive  <strong>to drink</strong></p>
                                        </div>
                                    </div>
                                    <div className="bg-emerald-100 p-4 rounded-xl">
                                        <p className="text-emerald-800 font-medium">Answer: "The doctor <strong>advised her to drink</strong> more water."</p>
                                    </div>
                                </div>
                            </div>
                        )
                    },
                    {
                        type: 'errorCorrection',
                        title: "Find the Errors",
                        sentences: [
                            { sentence: "I want learning English.", correct: false, correction: "I want to learn English.", explanation: "'Want' must be followed by a to-infinitive, not a gerund." },
                            { sentence: "She promised to help me.", correct: true, explanation: "Correct! 'Promise' is followed by a to-infinitive." },
                            { sentence: "He told me not call him.", correct: false, correction: "He told me not to call him.", explanation: "The negative infinitive needs 'to': not to call." },
                            { sentence: "I don't know how to cook.", correct: true, explanation: "Correct! After wh-words, we use to-infinitives." },
                            { sentence: "The teacher encouraged us work harder.", correct: false, correction: "The teacher encouraged us to work harder.", explanation: "'Encourage' follows: encourage + object + to-infinitive." }
                        ]
                    },
                    {
                        type: 'fillBlank',
                        title: "Complete the Sentences",
                        sentences: [
                            { text: "She agreed ___ me with my homework.", options: ["helping", "to help", "help"], answer: "to help" },
                            { text: "My parents allowed me ___ out tonight.", options: ["going", "to go", "go"], answer: "to go" },
                            { text: "I haven't decided where ___ for dinner.", options: ["to go", "go", "going"], answer: "to go" },
                            { text: "He reminded me ___ my keys.", options: ["bringing", "to bring", "bring"], answer: "to bring" }
                        ]
                    }
                ],
                practiceQuestions: [
                    { question: "She agreed ___ early tomorrow.", options: ["coming", "to come", "come", "came"], answer: "to come", explanation: "'Agree' is always followed by a to-infinitive." },
                    { question: "The teacher encouraged us ___ our best.", options: ["doing", "to do", "do", "did"], answer: "to do", explanation: "'Encourage' follows: encourage + object + to-infinitive." },
                    { question: "I'm happy ___ you again.", options: ["seeing", "to see", "see", "saw"], answer: "to see", explanation: "After adjectives describing feelings, use to-infinitives." },
                    { question: "Have you decided what ___ for the party?", options: ["wearing", "to wear", "wear", "wore"], answer: "to wear", explanation: "After wh-words (except why), use to-infinitives." },
                    { question: "Mum told me ___ late.", options: ["not to be", "to not be", "not being", "not be"], answer: "not to be", explanation: "The negative infinitive is 'not + to-infinitive'." },
                    { question: "He promised ___ again.", options: ["to not lie", "not to lie", "not lying", "lying not"], answer: "not to lie", explanation: "The negative infinitive is 'not + to-infinitive'." },
                    { question: "I need someone ___ me move this box.", options: ["helping", "to help", "help", "helped"], answer: "to help", explanation: "After indefinite pronouns (someone, something), use to-infinitives." },
                    { question: "She refused ___ to him.", options: ["talking", "to talk", "talk", "talked"], answer: "to talk", explanation: "'Refuse' is always followed by a to-infinitive." }
                ]
            },
            m3: {
                title: "Both Forms",
                icon: "repeat",
                color: "violet",
                phases: [
                    { id: 'learn', name: 'Learn' },
                    { id: 'guided', name: 'Guided Practice' },
                    { id: 'practice', name: 'Independent Practice' }
                ],
                learnSlides: [
                    {
                        title: "Verbs That Take Both",
                        content: (
                            <div className="space-y-6">
                                <div className="bg-violet-50 p-6 rounded-2xl border-l-4 border-violet-500">
                                    <p className="text-xl font-medium text-violet-900">Some verbs can be followed by <strong>either</strong> form with little or no change in meaning.</p>
                                </div>
                                <InteractiveWordList words={VERB_DATA.both.verbs} examples={VERB_DATA.both.examples} color="indigo" />
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-emerald-50 p-4 rounded-xl">
                                        <p className="font-bold text-emerald-800 mb-2">With Gerund:</p>
                                        <p>"I like <strong>swimming</strong>."</p>
                                    </div>
                                    <div className="bg-sky-50 p-4 rounded-xl">
                                        <p className="font-bold text-sky-800 mb-2">With To-infinitive:</p>
                                        <p>"I like <strong>to swim</strong>."</p>
                                    </div>
                                </div>
                            </div>
                        )
                    },
                    {
                        title: "Important Exceptions",
                        content: (
                            <div className="space-y-6">
                                <div className="bg-amber-50 p-6 rounded-2xl border-l-4 border-amber-500">
                                    <h4 className="font-bold text-amber-900 mb-3 flex items-center gap-2"><Icon name="alert-triangle" size={24} /> Exception 1: Would</h4>
                                    <p className="text-amber-800 mb-3">With <strong>would ('d)</strong>, you MUST use the to-infinitive.</p>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="bg-emerald-100 p-3 rounded-xl flex items-center gap-2">
                                            <Icon name="check" size={20} className="text-emerald-600" />
                                            <span>I'd <strong>like to go</strong>.</span>
                                        </div>
                                        <div className="bg-red-100 p-3 rounded-xl flex items-center gap-2 opacity-60">
                                            <Icon name="x" size={20} className="text-red-500" />
                                            <span className="line-through">I'd like going.</span>
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-rose-50 p-6 rounded-2xl border-l-4 border-rose-500">
                                    <h4 className="font-bold text-rose-900 mb-3 flex items-center gap-2"><Icon name="alert-triangle" size={24} /> Exception 2: Continuous Form</h4>
                                    <p className="text-rose-800 mb-3">When begin/start/continue are in continuous (-ing), use to-infinitive to avoid double -ing.</p>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="bg-emerald-100 p-3 rounded-xl flex items-center gap-2">
                                            <Icon name="check" size={20} className="text-emerald-600" />
                                            <span>It's starting <strong>to rain</strong>.</span>
                                        </div>
                                        <div className="bg-red-100 p-3 rounded-xl flex items-center gap-2 opacity-60">
                                            <Icon name="x" size={20} className="text-red-500" />
                                            <span className="line-through">It's starting raining.</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )
                    }
                ],
                guidedActivities: [
                    {
                        type: 'teacherModel',
                        title: "Teacher Model: Choosing the Right Form",
                        content: (
                            <div className="space-y-6">
                                <div className="bg-indigo-50 p-6 rounded-2xl">
                                    <p className="text-indigo-700 font-medium mb-4">Let's decide which form to use:</p>
                                    <div className="bg-white p-4 rounded-xl mb-4">
                                        <p className="text-lg mb-2"><strong>Sentence:</strong> "She would love ___ to Paris."</p>
                                        <div className="pl-4 border-l-4 border-indigo-300 space-y-2 mt-4">
                                            <p>Step 1: Main verb is "love" - normally takes both forms</p>
                                            <p>Step 2: BUT we have "would" before it!</p>
                                            <p>Step 3: Rule: would + like/love/prefer/hate = to-infinitive only</p>
                                        </div>
                                    </div>
                                    <div className="bg-emerald-100 p-4 rounded-xl">
                                        <p className="text-emerald-800 font-medium">Answer: "She would love <strong>to go</strong> to Paris."</p>
                                    </div>
                                </div>
                            </div>
                        )
                    },
                    {
                        type: 'fillBlank',
                        title: "Choose the Correct Form",
                        sentences: [
                            { text: "It started ___ when we arrived.", options: ["only raining", "raining / to rain (both OK)", "only to rain"], answer: "raining / to rain (both OK)" },
                            { text: "I would prefer ___ at home tonight.", options: ["staying", "to stay", "stay"], answer: "to stay" },
                            { text: "More people are beginning ___ online.", options: ["shopping", "to shop", "shop"], answer: "to shop" },
                            { text: "She loves ___ in the garden.", options: ["only working", "working / to work (both OK)", "only to work"], answer: "working / to work (both OK)" }
                        ]
                    }
                ],
                practiceQuestions: [
                    { question: "It started ___ heavily.", options: ["raining / to rain", "only raining", "only to rain", "rained"], answer: "raining / to rain", explanation: "'Start' can take either form with no meaning change." },
                    { question: "I would like ___ a coffee, please.", options: ["having", "to have", "have", "had"], answer: "to have", explanation: "'Would like' MUST be followed by a to-infinitive." },
                    { question: "People are beginning ___ the problem.", options: ["understanding", "to understand", "understand", "understood"], answer: "to understand", explanation: "When 'begin' is in continuous form, use to-infinitive to avoid double -ing." },
                    { question: "He'd prefer ___ by train.", options: ["travelling", "to travel", "travel", "travelled"], answer: "to travel", explanation: "'Would prefer' MUST be followed by a to-infinitive." },
                    { question: "I hate ___ early in the morning.", options: ["only waking up", "waking up / to wake up", "only to wake up", "wake up"], answer: "waking up / to wake up", explanation: "'Hate' can take either form in general statements." },
                    { question: "They continued ___ despite the rain.", options: ["playing / to play", "only playing", "only to play", "play"], answer: "playing / to play", explanation: "'Continue' can take either form." }
                ]
            },
            m4: {
                title: "Meaning Changes",
                icon: "git-branch",
                color: "amber",
                phases: [
                    { id: 'learn', name: 'Learn' },
                    { id: 'guided', name: 'Guided Practice' },
                    { id: 'practice', name: 'Independent Practice' }
                ],
                learnSlides: [
                    {
                        title: "Stop",
                        content: (
                            <div className="space-y-6">
                                <div className="bg-amber-50 p-6 rounded-2xl border-l-4 border-amber-500">
                                    <p className="text-xl font-medium text-amber-900">With <strong>stop</strong>, the form completely changes the meaning!</p>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-emerald-50 p-5 rounded-2xl border-2 border-emerald-200">
                                        <div className="bg-emerald-200 px-3 py-1 rounded-lg inline-block mb-3 text-sm font-bold text-emerald-900">STOP + GERUND</div>
                                        <p className="text-emerald-800 mb-3 font-medium">= Quit doing something</p>
                                        <div className="bg-white p-4 rounded-xl">
                                            <p className="text-lg">"He <strong>stopped smoking</strong>."</p>
                                            <p className="text-sm text-emerald-600 mt-2">= He quit. He doesn't smoke anymore.</p>
                                        </div>
                                    </div>
                                    <div className="bg-sky-50 p-5 rounded-2xl border-2 border-sky-200">
                                        <div className="bg-sky-200 px-3 py-1 rounded-lg inline-block mb-3 text-sm font-bold text-sky-900">STOP + TO-INFINITIVE</div>
                                        <p className="text-sky-800 mb-3 font-medium">= Pause in order to do something</p>
                                        <div className="bg-white p-4 rounded-xl">
                                            <p className="text-lg">"He <strong>stopped to smoke</strong>."</p>
                                            <p className="text-sm text-sky-600 mt-2">= He paused what he was doing so he could smoke.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )
                    },
                    {
                        title: "Remember & Forget",
                        content: (
                            <div className="space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-violet-50 p-5 rounded-2xl border-t-4 border-violet-500">
                                        <h4 className="font-bold text-violet-900 text-xl mb-4">REMEMBER</h4>
                                        <div className="space-y-3">
                                            <div className="bg-white p-3 rounded-xl">
                                                <p className="font-bold text-emerald-700">+ Gerund = Memory of past</p>
                                                <p className="text-sm">"I remember meeting him." (I have the memory)</p>
                                            </div>
                                            <div className="bg-white p-3 rounded-xl">
                                                <p className="font-bold text-sky-700">+ To-inf = Task to do</p>
                                                <p className="text-sm">"Remember to call me." (Don't forget to do it)</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-rose-50 p-5 rounded-2xl border-t-4 border-rose-500">
                                        <h4 className="font-bold text-rose-900 text-xl mb-4">FORGET</h4>
                                        <div className="space-y-3">
                                            <div className="bg-white p-3 rounded-xl">
                                                <p className="font-bold text-emerald-700">+ Gerund = No memory</p>
                                                <p className="text-sm">"I forgot meeting her." (I don't remember it)</p>
                                            </div>
                                            <div className="bg-white p-3 rounded-xl">
                                                <p className="font-bold text-sky-700">+ To-inf = Failed to do</p>
                                                <p className="text-sm">"I forgot to call." (I didn't do it)</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )
                    },
                    {
                        title: "Try & Go on",
                        content: (
                            <div className="space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-orange-50 p-5 rounded-2xl border-t-4 border-orange-500">
                                        <h4 className="font-bold text-orange-900 text-xl mb-4">TRY</h4>
                                        <div className="space-y-3">
                                            <div className="bg-white p-3 rounded-xl">
                                                <p className="font-bold text-emerald-700">+ Gerund = Experiment</p>
                                                <p className="text-sm">"Try adding salt." (See if it tastes better)</p>
                                            </div>
                                            <div className="bg-white p-3 rounded-xl">
                                                <p className="font-bold text-sky-700">+ To-inf = Make effort</p>
                                                <p className="text-sm">"Try to be on time." (Make an effort)</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-teal-50 p-5 rounded-2xl border-t-4 border-teal-500">
                                        <h4 className="font-bold text-teal-900 text-xl mb-4">GO ON</h4>
                                        <div className="space-y-3">
                                            <div className="bg-white p-3 rounded-xl">
                                                <p className="font-bold text-emerald-700">+ Gerund = Continue same</p>
                                                <p className="text-sm">"Go on reading." (Keep reading)</p>
                                            </div>
                                            <div className="bg-white p-3 rounded-xl">
                                                <p className="font-bold text-sky-700">+ To-inf = Move to next</p>
                                                <p className="text-sm">"Go on to read chapter 2." (Start something new)</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )
                    }
                ],
                guidedActivities: [
                    {
                        type: 'teacherModel',
                        title: "Teacher Model: Understanding Context",
                        content: (
                            <div className="space-y-6">
                                <div className="bg-indigo-50 p-6 rounded-2xl">
                                    <p className="text-indigo-700 font-medium mb-4">Context is key! Let's analyze:</p>
                                    <div className="bg-white p-4 rounded-xl mb-4">
                                        <p className="text-lg mb-2"><strong>Sentence:</strong> "I forgot ___ my camera. I have no photos!"</p>
                                        <div className="pl-4 border-l-4 border-indigo-300 space-y-2 mt-4">
                                            <p>Step 1: What's the situation?  "I have no photos"</p>
                                            <p>Step 2: This means I didn't bring my camera</p>
                                            <p>Step 3: "forget + to-infinitive" = failed to do something</p>
                                        </div>
                                    </div>
                                    <div className="bg-emerald-100 p-4 rounded-xl">
                                        <p className="text-emerald-800 font-medium">Answer: "I forgot <strong>to bring</strong> my camera."</p>
                                    </div>
                                </div>
                            </div>
                        )
                    },
                    {
                        type: 'errorCorrection',
                        title: "Choose the Right Meaning",
                        sentences: [
                            { sentence: "We stopped to eat lunch. (We paused our activity to have lunch)", correct: true, explanation: "Correct! 'Stop + to-infinitive' means pause to do something." },
                            { sentence: "He stopped to smoke last year. (He quit smoking)", correct: false, correction: "He stopped smoking last year.", explanation: "'Stop + gerund' means quit. 'Stop + to-infinitive' means pause to do something." },
                            { sentence: "Remember to lock the door! (Don't forget to do it)", correct: true, explanation: "Correct! 'Remember + to-infinitive' is a reminder about a future task." },
                            { sentence: "I tried to paint the wall blue, but I don't like the color. (I experimented)", correct: false, correction: "I tried painting the wall blue, but I don't like the color.", explanation: "'Try + gerund' means experiment. 'Try + to-infinitive' means make an effort." }
                        ]
                    },
                    {
                        type: 'fillBlank',
                        title: "Complete Based on Meaning",
                        sentences: [
                            { text: "I'll never forget ___ the Eiffel Tower for the first time. (memory of past)", options: ["to see", "seeing"], answer: "seeing" },
                            { text: "Please remember ___ the lights when you leave. (task to do)", options: ["turning off", "to turn off"], answer: "to turn off" },
                            { text: "The food was bland, so I tried ___ more spices. (experiment)", options: ["to add", "adding"], answer: "adding" },
                            { text: "We were hungry, so we stopped ___ some food. (pause to do)", options: ["buying", "to buy"], answer: "to buy" }
                        ]
                    }
                ],
                practiceQuestions: [
                    { question: "I forgot ___ my homework at home. (I didn't bring it)", options: ["bringing", "to bring"], answer: "to bring", explanation: "'Forget + to-infinitive' means failed to do a task." },
                    { question: "Do you remember ___ to the beach as a child? (memory)", options: ["to go", "going"], answer: "going", explanation: "'Remember + gerund' refers to a memory of a past event." },
                    { question: "She stopped ___ and looked at me. (quit the action)", options: ["to talk", "talking"], answer: "talking", explanation: "'Stop + gerund' means to end an activity." },
                    { question: "We stopped ___ photos of the sunset. (pause to do)", options: ["taking", "to take"], answer: "to take", explanation: "'Stop + to-infinitive' means pause to do something else." },
                    { question: "If you're tired, try ___ a nap. (experiment)", options: ["to take", "taking"], answer: "taking", explanation: "'Try + gerund' means experiment to see the result." },
                    { question: "Please try ___ more careful next time. (make effort)", options: ["being", "to be"], answer: "to be", explanation: "'Try + to-infinitive' means make an effort to do something." },
                    { question: "After lunch, we went on ___ the museum. (continue same)", options: ["to explore", "exploring"], answer: "exploring", explanation: "'Go on + gerund' means continue the same activity." },
                    { question: "After the introduction, he went on ___ the main points. (move to new)", options: ["explaining", "to explain"], answer: "to explain", explanation: "'Go on + to-infinitive' means move on to something new." }
                ]
            }
        };

        // --- MAIN MODULE COMPONENT ---
        // --- MAIN MODULE COMPONENT ---
        const ModuleScreen = ({ moduleId, initialState, onProgress, onExit }) => {
            const module = MODULE_DATA[moduleId];
            const [step, setStep] = useState(initialState?.step || 0);
            const [maxStepReached, setMaxStepReached] = useState(initialState?.maxStep || 0);

            // Report progress
            useEffect(() => {
                const newMax = Math.max(step, maxStepReached);
                if (newMax > maxStepReached) setMaxStepReached(newMax);
                if (onProgress) onProgress(step, newMax);
            }, [step, maxStepReached, onProgress]);

            const steps = ['Learn', 'Model', 'Check', 'Practice', 'Quiz'];
            const [learnIdx, setLearnIdx] = useState(0);
            const [practiceIdx, setPracticeIdx] = useState(0);
            const [completed, setCompleted] = useState(false);
            const [score, setScore] = useState(null);

            const shuffledPracticeQuestions = useMemo(() => {
                return shuffleArray(module.practiceQuestions);
            }, [module.practiceQuestions]);

            const handleNextLearn = () => {
                if (learnIdx < module.learnSlides.length - 1) {
                    setLearnIdx(learnIdx + 1);
                } else {
                    setStep(1); // Go to Model
                }
            };

            const handlePrevLearn = () => {
                if (learnIdx > 0) setLearnIdx(learnIdx - 1);
            };

            const handleNextPractice = () => {
                if (practiceIdx < module.practiceItems.length - 1) {
                    setPracticeIdx(practiceIdx + 1);
                } else {
                    setStep(4); // Go to Quiz
                }
            };

            const renderContent = () => {
                switch (step) {
                    case 0: // LEARN
                        return (
                            <div className="bg-white rounded-3xl shadow-xl overflow-hidden">
                                <div className="bg-slate-50 p-6 border-b border-slate-200">
                                    <div className="flex items-center gap-4">
                                        <div className={`p-3 rounded-xl bg-${module.color}-100`}>
                                            <Icon name={module.icon} size={32} className={`text-${module.color}-600`} />
                                        </div>
                                        <div>
                                            <p className="text-indigo-600 font-bold text-sm uppercase tracking-wider">Learn: {learnIdx + 1}/{module.learnSlides.length}</p>
                                            <h2 className="text-2xl font-black text-slate-800">{module.learnSlides[learnIdx].title}</h2>
                                        </div>
                                    </div>
                                </div>
                                <div className="p-8">
                                    {module.learnSlides[learnIdx].content}
                                </div>
                                <div className="p-6 bg-slate-50 flex justify-between border-t border-slate-200">
                                    <Button variant="outline" onClick={handlePrevLearn} disabled={learnIdx === 0}>
                                        <Icon name="arrow-left" size={20} /> Back
                                    </Button>
                                    <Button variant="primary" onClick={handleNextLearn}>
                                        {learnIdx === module.learnSlides.length - 1 ? "To Model" : "Next"} <Icon name="arrow-right" size={20} />
                                    </Button>
                                </div>
                            </div>
                        );

                    case 1: // MODEL
                        const modelActivity = module.modelContent;
                        return (
                            <div className="bg-white rounded-2xl shadow-lg overflow-hidden">
                                <div className="p-6 border-b border-slate-100">
                                    <h3 className="font-bold text-slate-800 text-xl">{modelActivity.title}</h3>
                                </div>
                                <div className="p-6">
                                    {modelActivity.content}
                                </div>
                                <div className="p-6 bg-slate-50 border-t">
                                    <Button variant="primary" onClick={() => setStep(2)} className="w-full">
                                        Proceed to Check <Icon name="arrow-right" size={20} />
                                    </Button>
                                </div>
                            </div>
                        );

                    case 2: // CHECK
                        return (
                            <ConceptCheckStep
                                questions={module.conceptQuestions || []}
                                onComplete={() => setStep(3)}
                                onReviewRequest={() => setStep(0)}
                            />
                        );

                    case 3: // PRACTICE
                        const currentPractice = module.practiceItems[practiceIdx];
                        return (
                            <div className="space-y-6">
                                <div className="bg-white rounded-2xl p-6 shadow-lg mb-6">
                                    <div className="flex items-center gap-3">
                                        <div className="p-2 bg-amber-100 rounded-lg">
                                            <Icon name="users" size={24} className="text-amber-600" />
                                        </div>
                                        <div>
                                            <h3 className="font-bold text-slate-800 text-xl">{currentPractice.title}</h3>
                                            <p className="text-slate-500 text-sm">Practice {practiceIdx + 1} of {module.practiceItems.length}</p>
                                        </div>
                                    </div>
                                </div>

                                {currentPractice.type === 'sorting' && (
                                    <SortingActivity
                                        items={currentPractice.items}
                                        categories={currentPractice.categories}
                                        onComplete={handleNextPractice}
                                    />
                                )}

                                {currentPractice.type === 'fillBlank' && (
                                    <FillBlankActivity
                                        sentences={currentPractice.sentences}
                                        onComplete={handleNextPractice}
                                    />
                                )}

                                {currentPractice.type === 'errorCorrection' && (
                                    <ErrorCorrectionActivity
                                        sentences={currentPractice.sentences}
                                        onComplete={handleNextPractice}
                                    />
                                )}
                            </div>
                        );

                    case 4: // QUIZ
                        return (
                            <QuizActivity
                                questions={shuffledPracticeQuestions}
                                onComplete={(s, t) => {
                                    setScore({ correct: s, total: t });
                                    setCompleted(true);
                                }}
                            />
                        );
                }
            };

            if (completed) {
                return (
                    <div className="max-w-2xl mx-auto fade-in">
                        <div className="bg-white rounded-3xl shadow-xl overflow-hidden">
                            <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-10 text-center text-white">
                                <div className="inline-flex p-4 bg-white/20 rounded-full mb-4">
                                    <Icon name="trophy" size={64} className="text-yellow-300" />
                                </div>
                                <h2 className="text-3xl font-black mb-2">Module Complete!</h2>
                                <div className="text-5xl font-black text-yellow-300 mb-2">{score.correct}/{score.total}</div>
                            </div>
                            <div className="p-8">
                                <Button onClick={onExit} variant="primary" className="w-full" size="lg">
                                    Back to Menu <Icon name="home" size={24} />
                                </Button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-4xl mx-auto fade-in">
                    <StepIndicator steps={steps} current={step} maxReached={maxStepReached} onStepClick={setStep} />
                    {renderContent()}
                </div>
            );
        };

        // --- FINAL CHALLENGE ---
        const FinalChallenge = ({ onExit }) => {
            const allQuestions = useMemo(() => {
                const all = Object.values(MODULE_DATA).flatMap(m => m.practiceQuestions);
                return shuffleArray(all).slice(0, 20);
            }, []);

            const [completed, setCompleted] = useState(false);
            const [score, setScore] = useState(null);

            if (completed) {
                return (
                    <div className="max-w-2xl mx-auto fade-in">
                        <div className="bg-white rounded-3xl shadow-xl overflow-hidden">
                            <div className="bg-gradient-to-r from-amber-500 to-orange-500 p-10 text-center text-white">
                                <div className="inline-flex p-4 bg-white/20 rounded-full mb-4">
                                    <Icon name="award" size={64} className="text-yellow-200" />
                                </div>
                                <h2 className="text-3xl font-black mb-2">Challenge Complete!</h2>
                                <div className="text-6xl font-black text-white mb-2">{score.correct}/{score.total}</div>
                                <p className="text-amber-100 text-xl">
                                    {score.correct === score.total ? "Perfect! You're a master!" :
                                        score.correct >= score.total * 0.8 ? "Excellent work!" :
                                            score.correct >= score.total * 0.6 ? "Good effort!" : "Keep practicing!"}
                                </p>
                            </div>
                            <div className="p-8">
                                <Button onClick={onExit} variant="primary" className="w-full" size="lg">
                                    Back to Menu <Icon name="home" size={24} />
                                </Button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-4xl mx-auto">
                    <div className="text-center mb-6">
                        <h2 className="text-3xl font-black text-slate-800">Final Challenge</h2>
                        <p className="text-slate-500">20 questions from all modules</p>
                    </div>
                    <QuizActivity
                        questions={allQuestions}
                        onComplete={(s, t) => { setScore({ correct: s, total: t }); setCompleted(true); }}
                    />
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [screen, setScreen] = useState('menu');
            const [moduleProgress, setModuleProgress] = useState({
                m1: { step: 0, maxStep: 0 },
                m2: { step: 0, maxStep: 0 },
                m3: { step: 0, maxStep: 0 },
                m4: { step: 0, maxStep: 0 }
            });

            const handleProgress = (moduleId, step, maxStep) => {
                setModuleProgress(prev => ({
                    ...prev,
                    [moduleId]: { step, maxStep: Math.max(maxStep, prev[moduleId]?.maxStep || 0) }
                }));
            };

            const renderMenu = () => (
                <div className="max-w-4xl mx-auto fade-in">
                    <header className="text-center mb-12">
                        <div className="inline-flex p-6 bg-indigo-100 rounded-full mb-4">
                            <Icon name="graduation-cap" size={64} className="text-indigo-600" />
                        </div>
                        <h1 className="text-5xl font-black text-slate-900 mb-2">Gerund & Infinitive</h1>
                        <p className="text-xl text-slate-500">Interactive Grammar Training  Unit 14</p>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        {[
                            { id: 'm1', title: "1. The Gerund", icon: "pen-tool", color: "bg-emerald-500", desc: "Using -ing forms" },
                            { id: 'm2', title: "2. To-Infinitives", icon: "terminal", color: "bg-sky-500", desc: "Using to + verb" },
                            { id: 'm3', title: "3. Both Forms", icon: "repeat", color: "bg-violet-500", desc: "Either form OK" },
                            { id: 'm4', title: "4. Meaning Changes", icon: "git-branch", color: "bg-amber-500", desc: "Stop, Try, Remember..." }
                        ].map(mod => (
                            <button
                                key={mod.id}
                                onClick={() => setScreen(mod.id)}
                                className="bg-white p-6 rounded-2xl shadow-sm border-2 border-slate-100 hover:border-indigo-200 hover:shadow-lg hover:-translate-y-1 transition-all text-left flex items-center gap-4 group"
                            >
                                <div className={`${mod.color} text-white p-4 rounded-xl shadow-lg group-hover:scale-110 transition-transform`}>
                                    <Icon name={mod.icon} size={32} />
                                </div>
                                <div>
                                    <h3 className="font-bold text-slate-800 text-xl">{mod.title}</h3>
                                    <p className="text-slate-500">{mod.desc}</p>
                                </div>
                                <div className="ml-auto text-right">
                                    {moduleProgress[mod.id].maxStep > 0 && (
                                        <div className="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1 mb-1">
                                            <span className="w-2 h-2 rounded-full bg-indigo-500"></span>
                                            Step {moduleProgress[mod.id].maxStep + 1}/5
                                        </div>
                                    )}
                                    <Icon name="chevron-right" size={24} className="text-slate-300 group-hover:text-indigo-500" />
                                </div>
                            </button>
                        ))}
                    </div>

                    <button
                        onClick={() => setScreen('final')}
                        className="w-full bg-gradient-to-r from-slate-800 to-slate-900 text-white p-8 rounded-2xl shadow-xl hover:shadow-2xl transition-all group"
                    >
                        <div className="flex items-center justify-between">
                            <div className="text-left">
                                <h3 className="text-2xl font-black text-amber-400 mb-1">Final Challenge</h3>
                                <p className="text-slate-300">Test your mastery with 20 mixed questions</p>
                            </div>
                            <div className="bg-amber-500 p-4 rounded-xl group-hover:scale-110 transition-transform">
                                <Icon name="trophy" size={32} className="text-white" />
                            </div>
                        </div>
                    </button>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-50 p-4 sm:p-8">
                    {screen !== 'menu' && (
                        <button
                            onClick={() => setScreen('menu')}
                            className="fixed top-4 left-4 p-3 bg-white rounded-full shadow-lg hover:shadow-xl text-slate-400 hover:text-slate-800 transition-all z-50 border border-slate-200"
                        >
                            <Icon name="home" size={24} />
                        </button>
                    )}

                    <div className="pt-4">
                        {screen === 'menu' && renderMenu()}
                        {screen === 'm1' && <ModuleScreen moduleId="m1" initialState={moduleProgress.m1} onProgress={(s, m) => handleProgress('m1', s, m)} onExit={() => setScreen('menu')} />}
                        {screen === 'm2' && <ModuleScreen moduleId="m2" initialState={moduleProgress.m2} onProgress={(s, m) => handleProgress('m2', s, m)} onExit={() => setScreen('menu')} />}
                        {screen === 'm3' && <ModuleScreen moduleId="m3" initialState={moduleProgress.m3} onProgress={(s, m) => handleProgress('m3', s, m)} onExit={() => setScreen('menu')} />}
                        {screen === 'm4' && <ModuleScreen moduleId="m4" initialState={moduleProgress.m4} onProgress={(s, m) => handleProgress('m4', s, m)} onExit={() => setScreen('menu')} />}
                        {screen === 'final' && <FinalChallenge onExit={() => setScreen('menu')} />}
                    </div>

                    <footer className="text-center text-slate-400 text-sm mt-12 pb-4">
                        S.3 English  Unit 14
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>